<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KAM Sentinel</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" defer></script>
<style>
:root {
  --bg:      #07090d;
  --bg2:     #0c1018;
  --bg3:     #111824;
  --border:  #1a2535;
  --border2: #243347;
  --cyan:    #00d4ff;
  --green:   #00ff88;
  --orange:  #ff7043;
  --purple:  #a855f7;
  --yellow:  #ffd600;
  --red:     #ff3d3d;
  --text:    #b8ccd8;
  --dim:     #3d5166;
  --white:   #e8f0f8;
}
* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Rajdhani', sans-serif;
  font-size: 15px;
  min-height: 100vh;
}

/* Subtle scanlines */
body::after {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:9999;
  background: repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.04) 3px,rgba(0,0,0,0.04) 4px);
}
/* Grid bg */
body::before {
  content:''; position:fixed; inset:0; pointer-events:none;
  background-image: linear-gradient(rgba(0,212,255,.025) 1px,transparent 1px),
                    linear-gradient(90deg,rgba(0,212,255,.025) 1px,transparent 1px);
  background-size: 48px 48px;
}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 24px;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  position: sticky; top:0; z-index:200;
}
.logo {
  font-family:'Share Tech Mono',monospace;
  font-size:1.2rem; letter-spacing:5px;
  color: var(--cyan);
  text-shadow: 0 0 24px rgba(0,212,255,.5);
}
.logo em { color: var(--dim); font-style:normal; }
.hdr-meta {
  display:flex; align-items:center; gap:16px;
}
.live-dot {
  width:8px; height:8px; border-radius:50%;
  background: var(--green); box-shadow:0 0 10px var(--green);
  animation: blink 2s infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
.mono { font-family:'Share Tech Mono',monospace; font-size:.7rem; color:var(--dim); }
.refresh-control {
  display:flex; align-items:center; gap:6px;
  background: var(--bg3); border:1px solid var(--border2);
  border-radius:4px; padding:4px 8px;
}
.refresh-select {
  background: transparent; border:none; color:var(--cyan);
  font-family:'Share Tech Mono',monospace; font-size:.7rem;
  cursor:pointer; outline:none;
}
.refresh-select option { background: var(--bg2); color:var(--text); }

/* â”€â”€ OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#kam-overlay {
  display:none;
  position:fixed; top:20px; right:20px; z-index:99999;
  background: rgba(7,9,13,0.92);
  border:1px solid var(--green);
  border-radius:8px;
  padding:10px 14px;
  min-width:180px;
  backdrop-filter: blur(12px);
  box-shadow: 0 0 20px rgba(0,255,136,.15), 0 4px 24px rgba(0,0,0,.6);
  font-family:'Share Tech Mono',monospace;
  font-size:.72rem;
  cursor:move;
  user-select:none;
}
#kam-overlay.visible { display:block; }
.overlay-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:8px; padding-bottom:6px;
  border-bottom:1px solid var(--border2);
}
.overlay-title {
  color:var(--green); font-size:.65rem; letter-spacing:3px;
}
.overlay-close {
  background:none; border:none; color:var(--dim);
  cursor:pointer; font-size:.8rem; padding:0 2px;
  line-height:1;
}
.overlay-close:hover { color:var(--red); }
.overlay-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:2px 0; gap:16px;
}
.overlay-label { color:var(--dim); font-size:.65rem; }
.overlay-val { color:var(--white); font-size:.75rem; font-weight:bold; }
.overlay-val.hot { color:var(--red); }
.overlay-val.warn { color:var(--yellow); }
.overlay-val.ok { color:var(--green); }
.overlay-divider {
  border:none; border-top:1px solid var(--border);
  margin:5px 0;
}
.overlay-settings-row {
  display:flex; gap:6px; margin-top:8px; padding-top:6px;
  border-top:1px solid var(--border2);
  flex-wrap:wrap;
}
.overlay-toggle {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--dim); font-family:'Share Tech Mono',monospace;
  font-size:.6rem; padding:3px 7px; border-radius:3px;
  cursor:pointer; transition:all .2s;
}
.overlay-toggle.active { border-color:var(--green); color:var(--green); }
.overlay-toggle:hover { border-color:var(--cyan); color:var(--cyan); }
  font-family:'Share Tech Mono',monospace; font-size:.62rem;
  border:1px solid var(--cyan); color:var(--cyan);
  padding:2px 8px; border-radius:2px; opacity:.6;
}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main { padding:20px 24px; max-width:1600px; margin:0 auto; }
.section-label {
  font-family:'Share Tech Mono',monospace; font-size:.6rem;
  letter-spacing:4px; color:var(--dim);
  margin-bottom:12px; margin-top:24px;
  display:flex; align-items:center; gap:10px;
}
.section-label::after {
  content:''; flex:1; height:1px; background:var(--border);
}

/* â”€â”€ SYSTEM INFO PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sysinfo-grid {
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:14px;
  margin-bottom:8px;
}
.sysinfo-card {
  background:var(--bg2); border:1px solid var(--border);
  border-radius:3px; padding:16px 18px;
  position:relative; overflow:hidden;
}
.sysinfo-card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, var(--cyan), transparent);
  opacity:.4;
}
.si-title {
  font-family:'Share Tech Mono',monospace; font-size:.6rem;
  letter-spacing:3px; color:var(--dim); margin-bottom:12px;
}
.si-row {
  display:flex; justify-content:space-between;
  align-items:baseline; margin-bottom:5px;
  font-size:.88rem;
}
.si-key { color:var(--dim); font-size:.8rem; }
.si-val { color:var(--white); font-weight:600; font-size:.88rem; text-align:right; max-width:60%; }
.si-val.accent-cyan   { color:var(--cyan); }
.si-val.accent-green  { color:var(--green); }
.si-val.accent-purple { color:var(--purple); }

/* â”€â”€ STAT CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stat-cards {
  display:grid; grid-template-columns:repeat(4,1fr); gap:14px;
}
.stat-card {
  background:var(--bg2); border:1px solid var(--border);
  border-radius:3px; padding:18px;
  position:relative; overflow:hidden;
  transition:border-color .3s, box-shadow .3s;
}
.stat-card:hover { border-color:var(--c); box-shadow:0 0 20px rgba(0,0,0,.4); }
.stat-card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background:var(--c, var(--cyan)); box-shadow:0 0 12px var(--c, var(--cyan));
}
.card-cpu    { --c: var(--cyan); }
.card-gpu    { --c: var(--green); }
.card-ram    { --c: var(--purple); }
.card-net    { --c: var(--orange); }

.card-tag {
  font-family:'Share Tech Mono',monospace; font-size:.58rem;
  letter-spacing:3px; color:var(--dim); margin-bottom:8px;
}
.card-big {
  font-size:2.6rem; font-weight:700; line-height:1;
  color:var(--c, var(--cyan));
  text-shadow:0 0 24px var(--c, var(--cyan));
}
.card-unit { font-size:.95rem; font-weight:400; opacity:.6; }
.card-details { margin-top:10px; }
.card-detail-row { display:flex; justify-content:space-between; font-size:.8rem; margin-bottom:3px; }
.cd-k { color:var(--dim); }
.cd-v { color:var(--text); font-weight:600; }
.cd-v.hot  { color:var(--red); }
.cd-v.warn { color:var(--yellow); }
.cd-v.ok   { color:var(--green); }

.bar {
  height:3px; background:var(--border); border-radius:2px;
  margin-top:12px; overflow:hidden;
}
.bar-fill {
  height:100%; border-radius:2px;
  background:var(--c, var(--cyan)); box-shadow:0 0 8px var(--c, var(--cyan));
  transition:width .4s cubic-bezier(.4,0,.2,1);
}

/* â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.charts-row {
  display:grid; grid-template-columns:1fr 1fr; gap:14px;
}
.chart-card {
  background:var(--bg2); border:1px solid var(--border);
  border-radius:3px; padding:18px;
}
.chart-hdr {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:14px;
}
.chart-title {
  font-family:'Share Tech Mono',monospace; font-size:.6rem;
  letter-spacing:3px; color:var(--dim);
}
.chart-legend { display:flex; gap:12px; }
.leg-item { display:flex; align-items:center; gap:5px; font-size:.75rem; color:var(--dim); }
.leg-dot { width:6px; height:6px; border-radius:50%; }
canvas { max-height:140px; }

/* â”€â”€ NET CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.net-split { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px; }
.net-half { text-align:center; }
.net-label { font-family:'Share Tech Mono',monospace; font-size:.55rem; letter-spacing:2px; color:var(--dim); margin-bottom:4px; }
.net-val { font-size:1.3rem; font-weight:700; color:var(--orange); }

/* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
footer {
  text-align:center; padding:16px;
  font-family:'Share Tech Mono',monospace; font-size:.6rem;
  color:var(--dim); border-top:1px solid var(--border); margin-top:24px;
}

/* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loading {
  position:fixed; inset:0; background:var(--bg); z-index:1000;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px;
}
.loading-logo {
  font-family:'Share Tech Mono',monospace; font-size:1.6rem;
  letter-spacing:6px; color:var(--cyan);
  text-shadow:0 0 30px rgba(0,212,255,.6);
}
.loading-bar { width:240px; height:2px; background:var(--border); border-radius:2px; overflow:hidden; }
.loading-bar-fill {
  height:100%; width:0%; background:var(--cyan);
  box-shadow:0 0 10px var(--cyan);
  animation: load 1.8s ease forwards;
}
@keyframes load { to { width:100%; } }
.loading-msg { font-family:'Share Tech Mono',monospace; font-size:.65rem; color:var(--dim); }

/* â”€â”€ STATUS ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert-bar {
  display:none; align-items:center; gap:10px;
  padding:8px 16px; border-radius:3px; margin-bottom:14px;
  font-size:.85rem; font-weight:600;
}
.alert-bar.warn { display:flex; background:rgba(255,214,0,.08); border:1px solid rgba(255,214,0,.3); color:var(--yellow); }
.alert-bar.danger { display:flex; background:rgba(255,61,61,.08); border:1px solid rgba(255,61,61,.3); color:var(--red); }

/* â”€â”€ SETTINGS BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-btn {
  font-family:'Share Tech Mono',monospace; font-size:.62rem;
  background:none; border:1px solid var(--dim); color:var(--dim);
  padding:3px 10px; border-radius:2px; cursor:pointer;
  transition:all .2s; letter-spacing:1px;
}
.settings-btn:hover { border-color:var(--cyan); color:var(--cyan); }

/* â”€â”€ WARNINGS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.warnings-panel { margin-bottom:14px; display:flex; flex-direction:column; gap:6px; }
.warn-item {
  display:flex; align-items:center; gap:10px;
  padding:9px 14px; border-radius:3px; font-size:.85rem; font-weight:600;
  animation: slideIn .3s ease;
}
@keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
.warn-item.warning  { background:rgba(255,214,0,.07); border:1px solid rgba(255,214,0,.25); color:var(--yellow); }
.warn-item.critical { background:rgba(255,61,61,.08);  border:1px solid rgba(255,61,61,.3);  color:var(--red); }
.warn-icon { font-size:1rem; flex-shrink:0; }
.warn-component { opacity:.6; margin-right:4px; font-size:.75rem; }
.warn-clear-btn { margin-left:auto; background:none; border:none; color:inherit; opacity:.4; cursor:pointer; font-size:.9rem; padding:0 4px; }
.warn-clear-btn:hover { opacity:1; }

/* â”€â”€ SETTINGS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay { display:none; position:fixed; inset:0; z-index:500; background:rgba(0,0,0,.75); backdrop-filter:blur(4px); align-items:center; justify-content:center; }
.modal-overlay.open { display:flex; }
.modal { background:var(--bg2); border:1px solid var(--border2); border-radius:4px; width:680px; max-width:95vw; max-height:85vh; overflow-y:auto; padding:28px; box-shadow:0 0 60px rgba(0,0,0,.6); }
.modal-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
.modal-title { font-family:'Share Tech Mono',monospace; font-size:.8rem; letter-spacing:4px; color:var(--cyan); }
.modal-close { background:none; border:none; color:var(--dim); font-size:1.2rem; cursor:pointer; padding:4px 8px; }
.modal-close:hover { color:var(--white); }
.modal-detected { font-size:.78rem; color:var(--dim); margin-bottom:20px; padding:8px 12px; background:var(--bg3); border-radius:3px; border-left:2px solid var(--cyan); }
.threshold-group { margin-bottom:24px; }
.tg-title { font-family:'Share Tech Mono',monospace; font-size:.62rem; letter-spacing:3px; color:var(--dim); margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid var(--border); }
.tg-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.tg-field { display:flex; flex-direction:column; gap:4px; }
.tg-label { font-size:.78rem; color:var(--text); }
.tg-input { background:var(--bg3); border:1px solid var(--border); color:var(--white); font-family:'Share Tech Mono',monospace; font-size:.82rem; padding:6px 10px; border-radius:2px; outline:none; transition:border-color .2s; }
.tg-input:focus { border-color:var(--cyan); }
.modal-actions { display:flex; gap:10px; margin-top:24px; justify-content:flex-end; }
.btn { font-family:'Share Tech Mono',monospace; font-size:.65rem; letter-spacing:2px; padding:8px 18px; border-radius:2px; cursor:pointer; transition:all .2s; border:none; }
.btn-primary { background:var(--cyan); color:var(--bg); font-weight:700; }
.btn-primary:hover { box-shadow:0 0 16px rgba(0,212,255,.4); }
.btn-secondary { background:none; border:1px solid var(--dim); color:var(--dim); }
.btn-secondary:hover { border-color:var(--white); color:var(--white); }
.btn-danger { background:none; border:1px solid rgba(255,61,61,.4); color:var(--red); }
.btn-danger:hover { background:rgba(255,61,61,.1); }
.save-status { font-family:'Share Tech Mono',monospace; font-size:.65rem; color:var(--green); opacity:0; transition:opacity .3s; align-self:center; }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width:1100px) {
  .stat-cards { grid-template-columns:repeat(2,1fr); }
  .sysinfo-grid { grid-template-columns:repeat(2,1fr); }
}
@media (max-width:700px) {
  .stat-cards { grid-template-columns:1fr; }
  .sysinfo-grid { grid-template-columns:1fr; }
  .charts-row { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading">
  <div class="loading-logo">KAM SENTINEL</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
  <div class="loading-msg" id="loading-msg">INITIALIZING SYSTEM SCAN...</div>
</div>

<!-- HEADER -->
<header>
  <div class="logo" style="display:flex;align-items:center;gap:10px;">
    <svg width="34" height="34" viewBox="0 0 160 160" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <clipPath id="shield-clip">
          <path d="M80 12 L138 36 L138 90 Q138 130 80 150 Q22 130 22 90 L22 36 Z"/>
        </clipPath>
        <radialGradient id="sg" cx="50%" cy="45%" r="55%">
          <stop offset="0%" stop-color="#00ff88" stop-opacity="0.15"/>
          <stop offset="100%" stop-color="#00ff88" stop-opacity="0"/>
        </radialGradient>
      </defs>
      <path d="M80 12 L138 36 L138 90 Q138 130 80 150 Q22 130 22 90 L22 36 Z" fill="url(#sg)"/>
      <g clip-path="url(#shield-clip)" opacity="0.25">
        <circle cx="80" cy="76" r="18" fill="none" stroke="#00ff88" stroke-width="1"/>
        <circle cx="80" cy="76" r="34" fill="none" stroke="#00ff88" stroke-width="1"/>
        <circle cx="80" cy="76" r="50" fill="none" stroke="#00ff88" stroke-width="1"/>
        <circle cx="80" cy="76" r="66" fill="none" stroke="#00ff88" stroke-width="1"/>
        <path d="M80 76 L80 10 A66 66 0 0 1 137 95 Z" fill="#00ff88" opacity="0.12"/>
        <line x1="80" y1="76" x2="80" y2="10" stroke="#00ff88" stroke-width="1" opacity="0.6"/>
        <line x1="80" y1="76" x2="137" y2="95" stroke="#00ff88" stroke-width="1" opacity="0.3"/>
      </g>
      <path d="M80 12 L138 36 L138 90 Q138 130 80 150 Q22 130 22 90 L22 36 Z" fill="none" stroke="#00ff88" stroke-width="2.5" stroke-linejoin="round"/>
      <line x1="68" y1="46" x2="68" y2="106" stroke="#00ff88" stroke-width="5" stroke-linecap="round"/>
      <line x1="68" y1="76" x2="104" y2="46" stroke="#00ff88" stroke-width="5" stroke-linecap="round"/>
      <line x1="68" y1="76" x2="104" y2="106" stroke="#00ff88" stroke-width="5" stroke-linecap="round"/>
      <ellipse cx="80" cy="76" rx="16" ry="10" fill="#07090d" stroke="#00ff8844" stroke-width="1"/>
      <circle cx="80" cy="76" r="9" fill="#00ff8818" stroke="#00ff88" stroke-width="1.5"/>
      <circle cx="80" cy="76" r="4.5" fill="#00ff88"/>
      <circle cx="83" cy="73" r="1.8" fill="#00ff88cc"/>
    </svg>
    KAM <em style="font-size:.7rem;letter-spacing:2px;">SENTINEL</em>
  </div>
  <div class="hdr-meta">
    <div class="live-dot"></div>
    <span class="mono" id="last-update">--:--:--</span>
    <div class="refresh-control">
      <span class="mono" style="font-size:.65rem;">REFRESH</span>
      <select id="refresh-select" class="refresh-select" onchange="updateRefreshRate(this.value)">
        <option value="2000">2s</option>
        <option value="5000" selected>5s</option>
        <option value="10000">10s</option>
        <option value="30000">30s</option>
        <option value="60000">60s</option>
      </select>
    </div>
    <button class="settings-btn" id="overlay-btn" onclick="toggleOverlay()">âŠž OVERLAY</button>
    <button class="settings-btn" onclick="openSettings()">âš™ THRESHOLDS</button>
  </div>
</header>

<main>

  <!-- WARNINGS PANEL -->
  <div id="warnings-panel" class="warnings-panel"></div>

  <!-- SYSTEM INFO -->
  <div class="section-label">SYSTEM INFORMATION</div>
  <div class="sysinfo-grid">

    <div class="sysinfo-card">
      <div class="si-title">HARDWARE</div>
      <div class="si-row"><span class="si-key">Manufacturer</span><span class="si-val" id="si-mfr">â€”</span></div>
      <div class="si-row"><span class="si-key">Model</span><span class="si-val" id="si-model">â€”</span></div>
      <div class="si-row"><span class="si-key">Motherboard</span><span class="si-val" id="si-mobo">â€”</span></div>
      <div class="si-row"><span class="si-key">BIOS</span><span class="si-val accent-cyan" id="si-bios">â€”</span></div>
    </div>

    <div class="sysinfo-card">
      <div class="si-title">PROCESSOR & MEMORY</div>
      <div class="si-row"><span class="si-key">CPU</span><span class="si-val accent-cyan" id="si-cpu">â€”</span></div>
      <div class="si-row"><span class="si-key">Cores / Threads</span><span class="si-val" id="si-cores">â€”</span></div>
      <div class="si-row"><span class="si-key">Max Clock</span><span class="si-val" id="si-maxghz">â€”</span></div>
      <div class="si-row"><span class="si-key">RAM</span><span class="si-val accent-purple" id="si-ram">â€”</span></div>
      <div class="si-row"><span class="si-key">Page File</span><span class="si-val" id="si-page">â€”</span></div>
    </div>

    <div class="sysinfo-card">
      <div class="si-title">SYSTEM & DISPLAY</div>
      <div class="si-row"><span class="si-key">OS</span><span class="si-val" id="si-os">â€”</span></div>
      <div class="si-row"><span class="si-key">Windows Dir</span><span class="si-val" id="si-windir">â€”</span></div>
      <div class="si-row"><span class="si-key">DirectX</span><span class="si-val accent-green" id="si-dx">â€”</span></div>
      <div class="si-row"><span class="si-key">GPU</span><span class="si-val accent-green" id="si-gpu">â€”</span></div>
      <div class="si-row"><span class="si-key">VRAM</span><span class="si-val" id="si-vram">â€”</span></div>
    </div>

  </div>

  <!-- LIVE METRICS -->
  <div class="section-label">LIVE PERFORMANCE</div>
  <div class="stat-cards">

    <!-- CPU -->
    <div class="stat-card card-cpu">
      <div class="card-tag">CPU</div>
      <div class="card-big"><span id="cpu-usage">--</span><span class="card-unit">%</span></div>
      <div class="card-details">
        <div class="card-detail-row"><span class="cd-k">Temp</span><span class="cd-v" id="cpu-temp">-- Â°C</span></div>
        <div class="card-detail-row"><span class="cd-k">Voltage</span><span class="cd-v" id="cpu-volt">-- V</span></div>
        <div class="card-detail-row"><span class="cd-k">Clock</span><span class="cd-v" id="cpu-freq">-- GHz</span></div>
        <div class="card-detail-row"><span class="cd-k">Cores / Threads</span><span class="cd-v" id="cpu-cores">--</span></div>
      </div>
      <div class="bar"><div class="bar-fill" id="cpu-bar" style="width:0%"></div></div>
    </div>

    <!-- GPU -->
    <div class="stat-card card-gpu">
      <div class="card-tag">GPU</div>
      <div class="card-big"><span id="gpu-usage">--</span><span class="card-unit">%</span></div>
      <div class="card-details">
        <div class="card-detail-row"><span class="cd-k">Temp</span><span class="cd-v" id="gpu-temp">-- Â°C</span></div>
        <div class="card-detail-row"><span class="cd-k">VRAM Used</span><span class="cd-v" id="gpu-vram">-- MB</span></div>
        <div class="card-detail-row"><span class="cd-k">Name</span><span class="cd-v" id="gpu-name" style="font-size:.75rem">--</span></div>
      </div>
      <div class="bar"><div class="bar-fill" id="gpu-bar" style="width:0%"></div></div>
    </div>

    <!-- RAM -->
    <div class="stat-card card-ram">
      <div class="card-tag">RAM</div>
      <div class="card-big"><span id="ram-usage">--</span><span class="card-unit">%</span></div>
      <div class="card-details">
        <div class="card-detail-row"><span class="cd-k">Used</span><span class="cd-v" id="ram-used">-- GB</span></div>
        <div class="card-detail-row"><span class="cd-k">Available</span><span class="cd-v" id="ram-avail">-- GB</span></div>
        <div class="card-detail-row"><span class="cd-k">Total</span><span class="cd-v" id="ram-total">-- GB</span></div>
      </div>
      <div class="bar"><div class="bar-fill" id="ram-bar" style="width:0%"></div></div>
    </div>

    <!-- NETWORK -->
    <div class="stat-card card-net">
      <div class="card-tag">NETWORK</div>
      <div class="net-split">
        <div class="net-half">
          <div class="net-label">â–² UPLOAD</div>
          <div class="net-val" id="net-up">-- KB/s</div>
        </div>
        <div class="net-half">
          <div class="net-label">â–¼ DOWNLOAD</div>
          <div class="net-val" id="net-down">-- KB/s</div>
        </div>
      </div>
      <div class="card-details" style="margin-top:10px">
        <div class="card-detail-row"><span class="cd-k">Upload kbps</span><span class="cd-v" id="net-up-raw">--</span></div>
        <div class="card-detail-row"><span class="cd-k">Download kbps</span><span class="cd-v" id="net-down-raw">--</span></div>
      </div>
      <div class="bar"><div class="bar-fill" id="net-bar" style="width:0%"></div></div>
    </div>

  </div>

  <!-- CHARTS -->
  <div class="section-label">PERFORMANCE HISTORY</div>
  <div class="charts-row">

    <div class="chart-card">
      <div class="chart-hdr">
        <span class="chart-title">CPU & GPU USAGE (%)</span>
        <div class="chart-legend">
          <div class="leg-item"><div class="leg-dot" style="background:var(--cyan)"></div>CPU</div>
          <div class="leg-item"><div class="leg-dot" style="background:var(--green)"></div>GPU</div>
        </div>
      </div>
      <canvas id="chart-usage"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-hdr">
        <span class="chart-title">TEMPERATURE (Â°C)</span>
        <div class="chart-legend">
          <div class="leg-item"><div class="leg-dot" style="background:var(--cyan)"></div>CPU</div>
          <div class="leg-item"><div class="leg-dot" style="background:var(--orange)"></div>GPU</div>
        </div>
      </div>
      <canvas id="chart-temp"></canvas>
    </div>

  </div>

</main>

<footer>KAM Sentinel v1.0 â€” Phase 1 &nbsp;|&nbsp; Running locally on port 5000 &nbsp;|&nbsp; Original profile backed up on first launch</footer>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <div class="modal-hdr">
      <span class="modal-title">WARNING THRESHOLDS</span>
      <button class="modal-close" onclick="closeSettings()">âœ•</button>
    </div>
    <div class="modal-detected" id="modal-detected">Detected hardware: loading...</div>

    <div class="threshold-group">
      <div class="tg-title">CPU TEMPERATURE (Â°C)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">âš¡ Warning at</label><input class="tg-input" id="t-cpu-temp-warn" type="number" step="1"></div>
        <div class="tg-field"><label class="tg-label">ðŸ”´ Critical at</label><input class="tg-input" id="t-cpu-temp-crit" type="number" step="1"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">GPU TEMPERATURE (Â°C)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">âš¡ Warning at</label><input class="tg-input" id="t-gpu-temp-warn" type="number" step="1"></div>
        <div class="tg-field"><label class="tg-label">ðŸ”´ Critical at</label><input class="tg-input" id="t-gpu-temp-crit" type="number" step="1"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">CPU VOLTAGE (V)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">Min safe voltage</label><input class="tg-input" id="t-volt-min" type="number" step="0.01"></div>
        <div class="tg-field"><label class="tg-label">Max safe voltage</label><input class="tg-input" id="t-volt-max" type="number" step="0.01"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">CPU USAGE (%)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">âš¡ Warning at</label><input class="tg-input" id="t-cpu-use-warn" type="number" step="1" min="1" max="100"></div>
        <div class="tg-field"><label class="tg-label">ðŸ”´ Critical at</label><input class="tg-input" id="t-cpu-use-crit" type="number" step="1" min="1" max="100"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">GPU USAGE (%)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">âš¡ Warning at</label><input class="tg-input" id="t-gpu-use-warn" type="number" step="1" min="1" max="100"></div>
        <div class="tg-field"><label class="tg-label">ðŸ”´ Critical at</label><input class="tg-input" id="t-gpu-use-crit" type="number" step="1" min="1" max="100"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">RAM USAGE (%)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">âš¡ Warning at</label><input class="tg-input" id="t-ram-warn" type="number" step="1" min="1" max="100"></div>
        <div class="tg-field"><label class="tg-label">ðŸ”´ Critical at</label><input class="tg-input" id="t-ram-crit" type="number" step="1" min="1" max="100"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">SUSTAINED USAGE ALERT (seconds of high usage before warning)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">CPU sustain window (sec)</label><input class="tg-input" id="t-cpu-sustain" type="number" step="5" min="5"></div>
        <div class="tg-field"><label class="tg-label">GPU sustain window (sec)</label><input class="tg-input" id="t-gpu-sustain" type="number" step="5" min="5"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">NETWORK ANOMALY</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">Spike multiplier (x baseline)</label><input class="tg-input" id="t-net-mult" type="number" step="0.5" min="1.5"></div>
        <div class="tg-field"><label class="tg-label">Baseline sample count</label><input class="tg-input" id="t-net-samples" type="number" step="1" min="5"></div>
      </div>
    </div>

    <div class="modal-actions">
      <span class="save-status" id="save-status">âœ“ SAVED</span>
      <button class="btn btn-danger" onclick="resetThresholds()">RESET TO DEFAULTS</button>
      <button class="btn btn-secondary" onclick="closeSettings()">CANCEL</button>
      <button class="btn btn-primary" onclick="saveThresholds()">SAVE THRESHOLDS</button>
    </div>
  </div>
</div>

<!-- KAM OVERLAY â€” draggable floating window -->
<div id="kam-overlay">
  <div class="overlay-header">
    <span class="overlay-title">â¬¡ KAM</span>
    <button class="overlay-close" onclick="toggleOverlay()">âœ•</button>
  </div>
  <div class="overlay-row" id="ov-cpu-row">
    <span class="overlay-label">CPU</span>
    <span class="overlay-val" id="ov-cpu">--%</span>
  </div>
  <div class="overlay-row" id="ov-cpu-temp-row">
    <span class="overlay-label">CPU TEMP</span>
    <span class="overlay-val" id="ov-cpu-temp">--Â°C</span>
  </div>
  <hr class="overlay-divider">
  <div class="overlay-row" id="ov-gpu-row">
    <span class="overlay-label">GPU</span>
    <span class="overlay-val" id="ov-gpu">--%</span>
  </div>
  <div class="overlay-row" id="ov-gpu-temp-row">
    <span class="overlay-label">GPU TEMP</span>
    <span class="overlay-val" id="ov-gpu-temp">--Â°C</span>
  </div>
  <hr class="overlay-divider">
  <div class="overlay-row" id="ov-ram-row">
    <span class="overlay-label">RAM</span>
    <span class="overlay-val" id="ov-ram">--%</span>
  </div>
  <div class="overlay-settings-row">
    <button class="overlay-toggle active" id="ov-tog-cpu" onclick="overlayToggle('cpu')">CPU</button>
    <button class="overlay-toggle active" id="ov-tog-gpu" onclick="overlayToggle('gpu')">GPU</button>
    <button class="overlay-toggle active" id="ov-tog-ram" onclick="overlayToggle('ram')">RAM</button>
    <button class="overlay-toggle active" id="ov-tog-temp" onclick="overlayToggle('temp')">TEMP</button>
  </div>
</div>

<script>
// â”€â”€ DOM cache â€” built once at init, never queried in hot path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DOM = {};
function cacheDom() {
  [
    'last-update','cpu-usage','cpu-bar','cpu-temp','cpu-volt','cpu-freq','cpu-cores',
    'gpu-usage','gpu-bar','gpu-temp','gpu-vram','gpu-name',
    'ram-usage','ram-bar','ram-used','ram-avail','ram-total',
    'net-up','net-down','net-up-raw','net-down-raw','net-bar',
    'warnings-panel','loading','loading-msg','settings-modal',
    'modal-detected','save-status',
    'si-mfr','si-model','si-mobo','si-bios','si-cpu','si-cores',
    'si-maxghz','si-ram','si-page','si-os','si-windir','si-dx','si-gpu','si-vram',
  ].forEach(id => DOM[id] = document.getElementById(id));
}

const CHART_OPTS = (yMax=100) => ({
  responsive:true, maintainAspectRatio:true,
  animation:{ duration:300 },
  plugins:{ legend:{ display:false }, tooltip:{ enabled:true, mode:'index', intersect:false }},
  scales:{
    x:{ display:false },
    y:{ min:0, max:yMax, grid:{ color:'rgba(255,255,255,.04)' },
        ticks:{ color:'#3d5166', font:{ size:10, family:'Share Tech Mono' }}}
  }
});

const mkChart = (id, datasets, yMax) => new Chart(document.getElementById(id), {
  type:'line', data:{ labels:[], datasets }, options: CHART_OPTS(yMax)
});

const line = (color, label) => ({
  label, data:[], borderColor:color,
  backgroundColor: color.replace(')',', 0.08)').replace('rgb','rgba'),
  borderWidth:1.5, pointRadius:0, tension:.4, fill:true
});

let chartUsage, chartTemp;

function initCharts() {
  chartUsage = mkChart('chart-usage', [
    line('rgb(0,212,255)', 'CPU %'),
    line('rgb(0,255,136)', 'GPU %'),
  ], 100);

  chartTemp = mkChart('chart-temp', [
    line('rgb(0,212,255)', 'CPU Â°C'),
    line('rgb(255,112,67)', 'GPU Â°C'),
  ], 100);
}

function pushChart(chart, label, ...vals) {
  chart.data.labels.push(label);
  vals.forEach((v,i) => chart.data.datasets[i].data.push(v ?? null));
  if(chart.data.labels.length > 60) {
    chart.data.labels.splice(0,1);
    chart.data.datasets.forEach(d => d.data.splice(0,1));
  }
  chart.update('none');
}

// â”€â”€ Temp color helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tempClass(v, warn=75, hot=90) {
  if(v===null||v===undefined) return '';
  return v>=hot?'hot':v>=warn?'warn':'ok';
}

// â”€â”€ Load system info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSystemInfo() {
  DOM['loading-msg'].textContent = 'SCANNING HARDWARE...';
  const r = await fetch('/api/system');
  const s = await r.json();
  const set = (id, val, fallback='N/A') => { if(DOM[id]) DOM[id].textContent = val || fallback; };
  set('si-mfr',    s.manufacturer);
  set('si-model',  s.model);
  set('si-mobo',   s.motherboard);
  set('si-bios',   s.bios_version);
  set('si-cpu',    s.cpu_name);
  set('si-cores',  `${s.cpu_cores} / ${s.cpu_threads}`);
  set('si-maxghz', s.cpu_max_ghz !== 'N/A' ? `${s.cpu_max_ghz} GHz` : 'N/A');
  set('si-ram',    `${s.ram_total_mb} MB  (${s.ram_total_gb} GB)`);
  set('si-page',   s.pagefile_total_mb ? `${s.pagefile_used_mb} MB used / ${s.pagefile_total_mb} MB` : 'N/A');
  set('si-os',     `Windows ${s.os_release}`);
  set('si-windir', s.windows_dir);
  set('si-dx',     s.directx);
  set('si-gpu',    s.gpu_name);
  set('si-vram',   s.gpu_vram_mb !== 'N/A' ? `${s.gpu_vram_mb} MB` : 'N/A');
}

// â”€â”€ FIX: Single fetch per cycle â€” one round trip instead of multiple â”€â”€â”€â”€â”€â”€
async function fetchStats() {
  try {
    const r = await fetch('/api/stats');
    const d = await r.json();
    const cpu = d.cpu, ram = d.ram, gpu = d.gpu, net = d.network;
    const ts  = new Date(d.timestamp * 1000).toLocaleTimeString();

    DOM['last-update'].textContent = ts;

    // CPU
    DOM['cpu-usage'].textContent   = cpu.usage ?? '--';
    DOM['cpu-bar'].style.width     = (cpu.usage||0) + '%';
    DOM['cpu-temp'].textContent    = cpu.temp !== null ? cpu.temp + ' Â°C' : 'N/A';
    DOM['cpu-temp'].className      = 'cd-v ' + tempClass(cpu.temp, 75, 90);
    DOM['cpu-volt'].textContent    = cpu.voltage !== null ? cpu.voltage + ' V' : 'N/A';
    DOM['cpu-freq'].textContent    = cpu.freq_ghz !== null ? cpu.freq_ghz + ' GHz' : 'N/A';
    DOM['cpu-cores'].textContent   = cpu.cores && cpu.threads ? `${cpu.cores} / ${cpu.threads}` : '--';

    // GPU
    DOM['gpu-usage'].textContent   = gpu.usage !== null ? gpu.usage : '--';
    DOM['gpu-bar'].style.width     = (gpu.usage||0) + '%';
    DOM['gpu-temp'].textContent    = gpu.temp !== null ? gpu.temp + ' Â°C' : 'N/A';
    DOM['gpu-temp'].className      = 'cd-v ' + tempClass(gpu.temp, 80, 95);
    DOM['gpu-vram'].textContent    = gpu.vram_used !== null ? `${gpu.vram_used} / ${gpu.vram_total} MB` : 'N/A';
    DOM['gpu-name'].textContent    = gpu.name || 'N/A';

    // RAM
    DOM['ram-usage'].textContent   = ram.usage_percent;
    DOM['ram-bar'].style.width     = ram.usage_percent + '%';
    DOM['ram-used'].textContent    = ram.used_gb + ' GB';
    DOM['ram-avail'].textContent   = ram.available_gb + ' GB';
    DOM['ram-total'].textContent   = ram.total_gb + ' GB';

    // Network
    DOM['net-up'].textContent      = net.upload_display;
    DOM['net-down'].textContent    = net.download_display;
    DOM['net-up-raw'].textContent  = net.upload_kbps + ' kbps';
    DOM['net-down-raw'].textContent= net.download_kbps + ' kbps';
    const netPct = Math.min((net.download_kbps / 12500) * 100, 100);
    DOM['net-bar'].style.width     = netPct + '%';

    // Charts â€” use history from server for accuracy
    if(d.history && d.history.timestamps.length) {
      const h = d.history;
      const labels = h.timestamps.map(t => new Date(t*1000).toLocaleTimeString());
      chartUsage.data.labels                  = labels;
      chartUsage.data.datasets[0].data        = h.cpu_usage;
      chartUsage.data.datasets[1].data        = h.gpu_usage;
      chartTemp.data.labels                   = labels;
      chartTemp.data.datasets[0].data         = h.cpu_temp;
      chartTemp.data.datasets[1].data         = h.gpu_temp;
      chartUsage.update('none');
      chartTemp.update('none');
    }

    // Warnings
    renderWarnings(d.warnings || []);

    // Update overlay if visible
    updateOverlay(cpu, gpu, ram);

  } catch(e) {
    console.warn('Stats fetch error:', e);
  }
}

// â”€â”€ Warnings panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _dismissed = new Set();

function renderWarnings(warnings) {
  const panel = DOM['warnings-panel'];
  const active = warnings.filter(w => !_dismissed.has(w.id));
  if(!active.length) { panel.innerHTML = ''; return; }
  panel.innerHTML = active.map(w => `
    <div class="warn-item ${w.level}" id="warn-${w.id}">
      <span class="warn-icon">${w.level==='critical'?'ðŸ”´':'âš¡'}</span>
      <span><span class="warn-component">[${w.component}]</span>${w.message}</span>
      <button class="warn-clear-btn" onclick="dismissWarning('${w.id}')">âœ•</button>
    </div>`).join('');
}

function dismissWarning(id) {
  _dismissed.add(id);
  const el = document.getElementById('warn-'+id);
  if(el) el.remove();
  setTimeout(() => _dismissed.delete(id), 60000);
}

// â”€â”€ Settings modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _thresholds = {};

async function loadThresholds() {
  const r = await fetch('/api/thresholds');
  _thresholds = await r.json();
  populateModal(_thresholds);
  const det = _thresholds._detected_from || {};
  DOM['modal-detected'].textContent =
    `Smart defaults detected from: ${det.cpu||'Unknown CPU'} / ${det.gpu||'Unknown GPU'}`;
}

function populateModal(t) {
  const set = (id, val) => { const el=document.getElementById(id); if(el&&val!=null) el.value=val; };
  set('t-cpu-temp-warn', t.cpu?.temp_warn);
  set('t-cpu-temp-crit', t.cpu?.temp_crit);
  set('t-gpu-temp-warn', t.gpu?.temp_warn);
  set('t-gpu-temp-crit', t.gpu?.temp_crit);
  set('t-volt-min',      t.voltage?.cpu_min);
  set('t-volt-max',      t.voltage?.cpu_max);
  set('t-cpu-use-warn',  t.cpu?.usage_warn);
  set('t-cpu-use-crit',  t.cpu?.usage_crit);
  set('t-gpu-use-warn',  t.gpu?.usage_warn);
  set('t-gpu-use-crit',  t.gpu?.usage_crit);
  set('t-ram-warn',      t.ram?.usage_warn);
  set('t-ram-crit',      t.ram?.usage_crit);
  set('t-cpu-sustain',   t.cpu?.usage_sustain_sec);
  set('t-gpu-sustain',   t.gpu?.usage_sustain_sec);
  set('t-net-mult',      t.network?.spike_multiplier);
  set('t-net-samples',   t.network?.baseline_samples);
}

function openSettings()  { DOM['settings-modal'].classList.add('open'); }
function closeSettings() { DOM['settings-modal'].classList.remove('open'); }

async function saveThresholds() {
  const get = id => parseFloat(document.getElementById(id)?.value);
  const payload = {
    cpu:     { temp_warn:get('t-cpu-temp-warn'), temp_crit:get('t-cpu-temp-crit'),
               usage_warn:get('t-cpu-use-warn'), usage_crit:get('t-cpu-use-crit'),
               usage_sustain_sec:get('t-cpu-sustain') },
    gpu:     { temp_warn:get('t-gpu-temp-warn'), temp_crit:get('t-gpu-temp-crit'),
               usage_warn:get('t-gpu-use-warn'), usage_crit:get('t-gpu-use-crit'),
               usage_sustain_sec:get('t-gpu-sustain') },
    ram:     { usage_warn:get('t-ram-warn'), usage_crit:get('t-ram-crit') },
    voltage: { cpu_min:get('t-volt-min'), cpu_max:get('t-volt-max') },
    network: { spike_multiplier:get('t-net-mult'), baseline_samples:get('t-net-samples') },
  };
  await fetch('/api/thresholds', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  DOM['save-status'].style.opacity = '1';
  setTimeout(() => DOM['save-status'].style.opacity = '0', 2000);
  _dismissed.clear();
}

async function resetThresholds() {
  if(!confirm('Reset all thresholds to smart defaults based on your hardware?')) return;
  const r = await fetch('/api/thresholds/reset', {method:'POST'});
  const data = await r.json();
  _thresholds = data.thresholds;
  populateModal(_thresholds);
  _dismissed.clear();
}

DOM['settings-modal']?.addEventListener('click', function(e) {
  if(e.target === this) closeSettings();
});

// â”€â”€ Goal 10: Update notification check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkForUpdate() {
  try {
    const r = await fetch('/api/version');
    const v = await r.json();
    if(v.update_check_url) {
      const remote = await fetch(v.update_check_url);
      const rv = await remote.json();
      if(rv.version && rv.version !== v.version) {
        showUpdateBanner(rv.version, rv.changelog || '');
      }
    }
  } catch(e) { /* No update server configured yet */ }
}

function showUpdateBanner(newVersion, changelog) {
  const banner = document.createElement('div');
  banner.className = 'warn-item warning';
  banner.style.marginBottom = '14px';
  banner.innerHTML = `
    <span class="warn-icon">ðŸ””</span>
    <span>KAM Sentinel <strong>${newVersion}</strong> is available!
    ${changelog ? `<em style="opacity:.7;font-size:.8rem"> â€” ${changelog}</em>` : ''}</span>
    <button class="warn-clear-btn" onclick="this.parentElement.remove()">âœ•</button>`;
  document.querySelector('main').prepend(banner);
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Refresh rate control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _refreshInterval = null;

function updateRefreshRate(ms) {
  ms = parseInt(ms);
  if(_refreshInterval) clearInterval(_refreshInterval);
  _refreshInterval = setInterval(fetchStats, ms);
  // Save preference
  localStorage.setItem('kam_refresh_ms', ms);
}

// â”€â”€ Overlay state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _ovState = { cpu:true, gpu:true, ram:true, temp:true };
let _overlayVisible = false;

function toggleOverlay() {
  _overlayVisible = !_overlayVisible;
  const el = document.getElementById('kam-overlay');
  const btn = document.getElementById('overlay-btn');
  el.classList.toggle('visible', _overlayVisible);
  btn.style.borderColor = _overlayVisible ? 'var(--green)' : '';
  btn.style.color       = _overlayVisible ? 'var(--green)' : '';
}

function overlayToggle(key) {
  _ovState[key] = !_ovState[key];
  document.getElementById('ov-tog-'+key).classList.toggle('active', _ovState[key]);
  // Show/hide rows
  if(key === 'cpu')  document.getElementById('ov-cpu-row').style.display = _ovState.cpu ? '' : 'none';
  if(key === 'gpu')  document.getElementById('ov-gpu-row').style.display = _ovState.gpu ? '' : 'none';
  if(key === 'ram')  document.getElementById('ov-ram-row').style.display = _ovState.ram ? '' : 'none';
  if(key === 'temp') {
    document.getElementById('ov-cpu-temp-row').style.display = _ovState.temp ? '' : 'none';
    document.getElementById('ov-gpu-temp-row').style.display = _ovState.temp ? '' : 'none';
  }
}

function updateOverlay(cpu, gpu, ram) {
  if(!_overlayVisible) return;
  const el = v => document.getElementById(v);
  if(_ovState.cpu) {
    el('ov-cpu').textContent = (cpu.usage ?? '--') + '%';
    el('ov-cpu').className = 'overlay-val ' + tempClass(cpu.usage, 80, 95);
  }
  if(_ovState.temp && cpu.temp !== null) {
    el('ov-cpu-temp').textContent = cpu.temp + 'Â°C';
    el('ov-cpu-temp').className = 'overlay-val ' + tempClass(cpu.temp, 75, 90);
  }
  if(_ovState.gpu && gpu.usage !== null) {
    el('ov-gpu').textContent = (gpu.usage ?? '--') + '%';
    el('ov-gpu').className = 'overlay-val ' + tempClass(gpu.usage, 85, 97);
  }
  if(_ovState.temp && gpu.temp !== null) {
    el('ov-gpu-temp').textContent = gpu.temp + 'Â°C';
    el('ov-gpu-temp').className = 'overlay-val ' + tempClass(gpu.temp, 80, 95);
  }
  if(_ovState.ram) {
    el('ov-ram').textContent = (ram.usage_percent ?? '--') + '%';
    el('ov-ram').className = 'overlay-val ' + tempClass(ram.usage_percent, 80, 92);
  }
}

// â”€â”€ Overlay drag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  let dragging=false, ox=0, oy=0;
  document.addEventListener('DOMContentLoaded', () => {
    const ov = document.getElementById('kam-overlay');
    ov.addEventListener('mousedown', e => {
      if(e.target.tagName === 'BUTTON') return;
      dragging = true;
      ox = e.clientX - ov.offsetLeft;
      oy = e.clientY - ov.offsetTop;
      ov.style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', e => {
      if(!dragging) return;
      const x = Math.max(0, Math.min(window.innerWidth  - ov.offsetWidth,  e.clientX - ox));
      const y = Math.max(0, Math.min(window.innerHeight - ov.offsetHeight, e.clientY - oy));
      ov.style.left = x + 'px';
      ov.style.top  = y + 'px';
      ov.style.right = 'auto';
    });
    document.addEventListener('mouseup', () => {
      dragging = false;
      document.getElementById('kam-overlay').style.cursor = 'move';
    });
  });
})();

async function init() {
  cacheDom();
  initCharts();
  await loadSystemInfo();
  await loadThresholds();
  DOM['loading-msg'].textContent = 'LOADING METRICS...';
  await fetchStats();
  DOM['loading'].style.opacity    = '0';
  DOM['loading'].style.transition = 'opacity .5s';
  setTimeout(() => DOM['loading'].style.display = 'none', 500);
  // Restore saved refresh rate
  const savedMs = parseInt(localStorage.getItem('kam_refresh_ms') || '5000');
  const sel = document.getElementById('refresh-select');
  if(sel) sel.value = savedMs;
  _refreshInterval = setInterval(fetchStats, savedMs);
  // Check for updates once on load (Goal 10)
  setTimeout(checkForUpdate, 3000);
}

window.addEventListener('load', init);
</script>
</body>
</html>
