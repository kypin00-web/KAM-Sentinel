<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KAM Sentinel</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" defer></script>
<style>
:root {
  /* Core backgrounds - deeper contrast */
  --bg:      #050709;
  --bg2:     #0a0e17;
  --bg3:     #0f1520;
  --bg4:     #141c2b;
  /* Borders */
  --border:  #1a2535;
  --border2: #243347;
  --border3: #2e4060;
  /* Brand colors - more saturated */
  --cyan:    #00e5ff;
  --green:   #00ff88;
  --orange:  #ff6b35;
  --purple:  #c084fc;
  --yellow:  #ffd600;
  --red:     #ff4444;
  --pink:    #f472b6;
  /* Text */
  --text:    #c8dce8;
  --dim:     #3d5166;
  --dim2:    #526a80;
  --white:   #eef4fb;
  /* Glows */
  --glow-cyan:   rgba(0,229,255,.2);
  --glow-green:  rgba(0,255,136,.2);
  --glow-purple: rgba(192,132,252,.2);
  --glow-orange: rgba(255,107,53,.2);
}
* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  background-image: 
    radial-gradient(ellipse 80% 50% at 50% -10%, rgba(0,229,255,.04) 0%, transparent 60%),
    radial-gradient(ellipse 50% 40% at 90% 90%, rgba(0,255,136,.03) 0%, transparent 50%);
  color: var(--text);
  font-family: 'Rajdhani', sans-serif;
  font-size: 15px;
  min-height: 100vh;
}

/* Subtle scanlines */
body::after {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:9999;
  background: repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.04) 3px,rgba(0,0,0,0.04) 4px);
}
/* Grid bg */
body::before {
  content:''; position:fixed; inset:0; pointer-events:none;
  background-image: linear-gradient(rgba(0,212,255,.025) 1px,transparent 1px),
                    linear-gradient(90deg,rgba(0,212,255,.025) 1px,transparent 1px);
  background-size: 48px 48px;
}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 28px;
  background: rgba(10,14,23,0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  position: sticky; top:0; z-index:200;
  box-shadow: 0 4px 32px rgba(0,0,0,.4), 0 1px 0 rgba(0,229,255,.05);
}
.logo {
  font-family:'Share Tech Mono',monospace;
  font-size:1.2rem; letter-spacing:5px;
  color: var(--cyan);
  text-shadow: 0 0 24px rgba(0,212,255,.5);
}
.logo em { color: var(--dim); font-style:normal; }
.hdr-meta {
  display:flex; align-items:center; gap:16px;
}
.live-dot {
  width:8px; height:8px; border-radius:50%;
  background: var(--green); box-shadow:0 0 10px var(--green);
  animation: blink 2s infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
.mono { font-family:'Share Tech Mono',monospace; font-size:.7rem; color:var(--dim); }
.refresh-control {
  display:flex; align-items:center; gap:6px;
  background: var(--bg3); border:1px solid var(--border2);
  border-radius:4px; padding:4px 8px;
}
.refresh-select {
  background: transparent; border:none; color:var(--cyan);
  font-family:'Share Tech Mono',monospace; font-size:.7rem;
  cursor:pointer; outline:none;
}
.refresh-select option { background: var(--bg2); color:var(--text); }

/* â”€â”€ OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#kam-overlay {
  display:none;
  position:fixed; top:20px; right:20px; z-index:99999;
  background: rgba(7,9,13,0.92);
  border:1px solid var(--green);
  border-radius:8px;
  padding:10px 14px;
  min-width:180px;
  backdrop-filter: blur(12px);
  box-shadow: 0 0 20px rgba(0,255,136,.15), 0 4px 24px rgba(0,0,0,.6);
  font-family:'Share Tech Mono',monospace;
  font-size:.72rem;
  cursor:move;
  user-select:none;
}
#kam-overlay.visible { display:block; }
.overlay-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:8px; padding-bottom:6px;
  border-bottom:1px solid var(--border2);
}
.overlay-title {
  color:var(--green); font-size:.65rem; letter-spacing:3px;
}
.overlay-close {
  background:none; border:none; color:var(--dim);
  cursor:pointer; font-size:.8rem; padding:0 2px;
  line-height:1;
}
.overlay-close:hover { color:var(--red); }
.overlay-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:2px 0; gap:16px;
}
.overlay-label { color:var(--dim); font-size:.65rem; }
.overlay-val { color:var(--white); font-size:.75rem; font-weight:bold; }
.overlay-val.hot { color:var(--red); }
.overlay-val.warn { color:var(--yellow); }
.overlay-val.ok { color:var(--green); }
.overlay-divider {
  border:none; border-top:1px solid var(--border);
  margin:5px 0;
}
.overlay-settings-row {
  display:flex; gap:6px; margin-top:8px; padding-top:6px;
  border-top:1px solid var(--border2);
  flex-wrap:wrap;
}
.overlay-toggle {
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--dim); font-family:'Share Tech Mono',monospace;
  font-size:.6rem; padding:3px 7px; border-radius:3px;
  cursor:pointer; transition:all .2s;
}
.overlay-toggle.active { border-color:var(--green); color:var(--green); }
.diag-btn {
  background: none; border: 1px solid var(--yellow);
  color: var(--yellow); font-size: .6rem; padding: 1px 5px;
  border-radius: 3px; cursor: pointer; margin-left: 6px;
  animation: blink 2s infinite;
  vertical-align: middle;
}
.diag-btn:hover { background: var(--yellow); color: var(--bg); }

/* â”€â”€ FEEDBACK MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.feedback-modal {
  display:none; position:fixed; inset:0; z-index:10000;
  background: rgba(0,0,0,.75); backdrop-filter:blur(6px);
  align-items:center; justify-content:center;
}
.feedback-modal.open { display:flex; }
.feedback-box {
  background: linear-gradient(135deg, var(--bg2), var(--bg3));
  border: 1px solid var(--border3); border-radius:12px;
  padding:28px; max-width:480px; width:90%;
  box-shadow: 0 0 60px rgba(0,229,255,.08), 0 24px 64px rgba(0,0,0,.6);
}
.feedback-title {
  color:var(--cyan); font-size:.8rem; letter-spacing:3px;
  margin-bottom:20px; display:flex; align-items:center; gap:8px;
}
.feedback-cats {
  display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;
}
.fb-cat {
  background:var(--bg4); border:1px solid var(--border2);
  color:var(--dim2); font-family:'Share Tech Mono',monospace;
  font-size:.65rem; padding:5px 12px; border-radius:20px;
  cursor:pointer; transition:all .2s; letter-spacing:1px;
}
.fb-cat.active { border-color:var(--cyan); color:var(--cyan); background:rgba(0,229,255,.06); }
.fb-textarea {
  width:100%; background:var(--bg4); border:1px solid var(--border2);
  color:var(--white); border-radius:6px; padding:12px;
  font-family:'Rajdhani',sans-serif; font-size:.9rem;
  resize:vertical; min-height:100px; outline:none;
  transition:border-color .2s;
}
.fb-textarea:focus { border-color:var(--cyan); }
.fb-textarea::placeholder { color:var(--dim); }
.fb-footer {
  display:flex; justify-content:space-between; align-items:center;
  margin-top:14px;
}
.fb-note { font-size:.7rem; color:var(--dim); }
.fb-actions { display:flex; gap:8px; }
.fb-cancel {
  background:none; border:1px solid var(--border2); color:var(--dim);
  padding:7px 16px; border-radius:5px; cursor:pointer;
  font-family:'Share Tech Mono',monospace; font-size:.65rem;
}
.fb-cancel:hover { border-color:var(--text); color:var(--text); }
.fb-submit {
  background:linear-gradient(135deg, var(--cyan), var(--green));
  border:none; color:var(--bg); font-weight:bold;
  padding:7px 20px; border-radius:5px; cursor:pointer;
  font-family:'Share Tech Mono',monospace; font-size:.65rem;
  transition:opacity .2s;
}
.fb-submit:hover { opacity:.85; }
.fb-submit:disabled { opacity:.4; cursor:not-allowed; }
.diag-modal {
  display:none; position:fixed; inset:0; z-index:10000;
  background: rgba(0,0,0,.7); backdrop-filter:blur(4px);
  align-items:center; justify-content:center;
}
.diag-modal.open { display:flex; }
.diag-box {
  background: var(--bg2); border: 1px solid var(--yellow);
  border-radius: 8px; padding: 24px; max-width: 480px; width: 90%;
  box-shadow: 0 0 40px rgba(255,214,0,.1);
}
.diag-title { color:var(--yellow); font-size:.8rem; letter-spacing:3px; margin-bottom:16px; }
.diag-status { font-size:.85rem; color:var(--text); margin-bottom:12px; line-height:1.6; }
.diag-fix { font-family:'Share Tech Mono',monospace; font-size:.75rem;
  background:var(--bg3); border:1px solid var(--border2);
  color:var(--cyan); padding:8px 12px; border-radius:4px; margin-bottom:16px; }
.diag-actions { display:flex; gap:10px; flex-wrap:wrap; }
.diag-close { background:none; border:1px solid var(--border2); color:var(--dim);
  padding:6px 16px; border-radius:4px; cursor:pointer; font-family:'Share Tech Mono',monospace; font-size:.7rem; }
.diag-close:hover { border-color:var(--text); color:var(--text); }
.diag-autofix { background:var(--green); border:none; color:var(--bg);
  padding:6px 16px; border-radius:4px; cursor:pointer; font-family:'Share Tech Mono',monospace;
  font-size:.7rem; font-weight:bold; }
.diag-autofix:hover { opacity:.85; }
.diag-autofix:disabled { opacity:.4; cursor:not-allowed; }
  font-family:'Share Tech Mono',monospace; font-size:.62rem;
  border:1px solid var(--cyan); color:var(--cyan);
  padding:2px 8px; border-radius:2px; opacity:.6;
}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main { padding:20px 24px; max-width:1600px; margin:0 auto; }
.section-label {
  font-family:'Share Tech Mono',monospace; font-size:.6rem;
  letter-spacing:4px; color:var(--dim);
  margin-bottom:12px; margin-top:24px;
  display:flex; align-items:center; gap:10px;
}
.section-label::after {
  content:''; flex:1; height:1px; background:var(--border);
}

/* â”€â”€ SYSTEM INFO PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sysinfo-grid {
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:14px;
  margin-bottom:8px;
}
.sysinfo-card {
  background:var(--bg2); border:1px solid var(--border);
  border-radius:3px; padding:16px 18px;
  position:relative; overflow:hidden;
}
.sysinfo-card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, var(--cyan), transparent);
  opacity:.4;
}
.si-title {
  font-family:'Share Tech Mono',monospace; font-size:.6rem;
  letter-spacing:3px; color:var(--dim); margin-bottom:12px;
}
.si-row {
  display:flex; justify-content:space-between;
  align-items:baseline; margin-bottom:5px;
  font-size:.88rem;
}
.si-key { color:var(--dim); font-size:.8rem; }
.si-val { color:var(--white); font-weight:600; font-size:.88rem; text-align:right; max-width:60%; }
.si-val.accent-cyan   { color:var(--cyan); }
.si-val.accent-green  { color:var(--green); }
.si-val.accent-purple { color:var(--purple); }

/* â”€â”€ STAT CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stat-cards {
  display:grid; grid-template-columns:repeat(4,1fr); gap:14px;
}
.stat-card {
  background: linear-gradient(135deg, var(--bg2) 0%, var(--bg3) 100%);
  border:1px solid var(--border);
  border-radius:8px; padding:20px;
  position:relative; overflow:hidden;
  transition:border-color .3s, box-shadow .3s, transform .2s;
  backdrop-filter: blur(4px);
}
.stat-card:hover { 
  border-color:var(--c); 
  box-shadow:0 0 30px var(--glow-cyan), 0 8px 32px rgba(0,0,0,.5);
  transform: translateY(-1px);
}
.stat-card.card-cpu:hover  { box-shadow:0 0 30px var(--glow-cyan),  0 8px 32px rgba(0,0,0,.5); }
.stat-card.card-gpu:hover  { box-shadow:0 0 30px var(--glow-green), 0 8px 32px rgba(0,0,0,.5); }
.stat-card.card-ram:hover  { box-shadow:0 0 30px var(--glow-purple),0 8px 32px rgba(0,0,0,.5); }
.stat-card.card-net:hover  { box-shadow:0 0 30px var(--glow-orange),0 8px 32px rgba(0,0,0,.5); }
.stat-card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg, transparent, var(--c, var(--cyan)), transparent);
  box-shadow:0 0 16px var(--c, var(--cyan));
}
.stat-card::after {
  content:''; position:absolute; inset:0; pointer-events:none;
  background: linear-gradient(135deg, rgba(255,255,255,.02) 0%, transparent 60%);
  border-radius:8px;
}
.card-cpu    { --c: var(--cyan); }
.card-gpu    { --c: var(--green); }
.card-ram    { --c: var(--purple); }
.card-net    { --c: var(--orange); }

.card-tag {
  font-family:'Share Tech Mono',monospace; font-size:.58rem;
  letter-spacing:3px; color:var(--dim); margin-bottom:8px;
}
.card-big {
  font-size:2.6rem; font-weight:700; line-height:1;
  color:var(--c, var(--cyan));
  text-shadow:0 0 24px var(--c, var(--cyan));
}
.card-unit { font-size:.95rem; font-weight:400; opacity:.6; }
.card-details { margin-top:10px; }
.card-detail-row { display:flex; justify-content:space-between; font-size:.8rem; margin-bottom:3px; }
.cd-k { color:var(--dim); }
.cd-v { color:var(--text); font-weight:600; }
.cd-v.hot  { color:var(--red); }
.cd-v.warn { color:var(--yellow); }
.cd-v.ok   { color:var(--green); }

.bar {
  height:3px; background:var(--border); border-radius:2px;
  margin-top:12px; overflow:hidden;
}
.bar-fill {
  height:100%; border-radius:2px;
  background:var(--c, var(--cyan)); box-shadow:0 0 8px var(--c, var(--cyan));
  transition:width .4s cubic-bezier(.4,0,.2,1);
}

/* â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.charts-row {
  display:grid; grid-template-columns:1fr 1fr; gap:14px;
}
.chart-card {
  background: linear-gradient(135deg, var(--bg2) 0%, var(--bg3) 100%);
  border:1px solid var(--border);
  border-radius:8px; padding:20px;
  backdrop-filter: blur(4px);
  transition: border-color .3s, box-shadow .3s;
}
.chart-card:hover {
  border-color: var(--border3);
  box-shadow: 0 0 20px rgba(0,0,0,.4);
}
.chart-hdr {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:14px;
}
.chart-title {
  font-family:'Share Tech Mono',monospace; font-size:.6rem;
  letter-spacing:3px; color:var(--dim);
}
.chart-legend { display:flex; gap:12px; }
.leg-item { display:flex; align-items:center; gap:5px; font-size:.75rem; color:var(--dim); }
.leg-dot { width:6px; height:6px; border-radius:50%; }
canvas { max-height:140px; }

/* â”€â”€ NET CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.net-split { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px; }
.net-half { text-align:center; }
.net-label { font-family:'Share Tech Mono',monospace; font-size:.55rem; letter-spacing:2px; color:var(--dim); margin-bottom:4px; }
.net-val { font-size:1.3rem; font-weight:700; color:var(--orange); }

/* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
footer {
  text-align:center; padding:16px;
  font-family:'Share Tech Mono',monospace; font-size:.6rem;
  color:var(--dim); border-top:1px solid var(--border); margin-top:24px;
}

/* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loading {
  position:fixed; inset:0; background:var(--bg); z-index:1000;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px;
}
.loading-logo {
  font-family:'Share Tech Mono',monospace; font-size:1.6rem;
  letter-spacing:6px; color:var(--cyan);
  text-shadow:0 0 30px rgba(0,212,255,.6);
}
.loading-bar { width:240px; height:2px; background:var(--border); border-radius:2px; overflow:hidden; }
.loading-bar-fill {
  height:100%; width:0%; background:var(--cyan);
  box-shadow:0 0 10px var(--cyan);
  animation: load 1.8s ease forwards;
}
@keyframes load { to { width:100%; } }
.loading-msg { font-family:'Share Tech Mono',monospace; font-size:.65rem; color:var(--dim); }

/* â”€â”€ STATUS ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert-bar {
  display:none; align-items:center; gap:10px;
  padding:8px 16px; border-radius:3px; margin-bottom:14px;
  font-size:.85rem; font-weight:600;
}
.alert-bar.warn { display:flex; background:rgba(255,214,0,.08); border:1px solid rgba(255,214,0,.3); color:var(--yellow); }
.alert-bar.danger { display:flex; background:rgba(255,61,61,.08); border:1px solid rgba(255,61,61,.3); color:var(--red); }

/* â”€â”€ SETTINGS BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-btn {
  font-family:'Share Tech Mono',monospace; font-size:.62rem;
  background:none; border:1px solid var(--dim); color:var(--dim);
  padding:3px 10px; border-radius:2px; cursor:pointer;
  transition:all .2s; letter-spacing:1px;
}
.settings-btn:hover { border-color:var(--cyan); color:var(--cyan); }

/* â”€â”€ WARNINGS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.warnings-panel { margin-bottom:14px; display:flex; flex-direction:column; gap:6px; }
.warn-item {
  display:flex; align-items:center; gap:10px;
  padding:9px 14px; border-radius:3px; font-size:.85rem; font-weight:600;
  animation: slideIn .3s ease;
}
@keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
.warn-item.warning  { background:rgba(255,214,0,.07); border:1px solid rgba(255,214,0,.25); color:var(--yellow); }
.warn-item.critical { background:rgba(255,61,61,.08);  border:1px solid rgba(255,61,61,.3);  color:var(--red); }
.warn-icon { font-size:1rem; flex-shrink:0; }
.warn-component { opacity:.6; margin-right:4px; font-size:.75rem; }
.warn-clear-btn { margin-left:auto; background:none; border:none; color:inherit; opacity:.4; cursor:pointer; font-size:.9rem; padding:0 4px; }
.warn-clear-btn:hover { opacity:1; }

/* â”€â”€ SETTINGS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay { display:none; position:fixed; inset:0; z-index:500; background:rgba(0,0,0,.75); backdrop-filter:blur(4px); align-items:center; justify-content:center; }
.modal-overlay.open { display:flex; }
.modal { background:var(--bg2); border:1px solid var(--border2); border-radius:4px; width:680px; max-width:95vw; max-height:85vh; overflow-y:auto; padding:28px; box-shadow:0 0 60px rgba(0,0,0,.6); }
.modal-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
.modal-title { font-family:'Share Tech Mono',monospace; font-size:.8rem; letter-spacing:4px; color:var(--cyan); }
.modal-close { background:none; border:none; color:var(--dim); font-size:1.2rem; cursor:pointer; padding:4px 8px; }
.modal-close:hover { color:var(--white); }
.modal-detected { font-size:.78rem; color:var(--dim); margin-bottom:20px; padding:8px 12px; background:var(--bg3); border-radius:3px; border-left:2px solid var(--cyan); }
.threshold-group { margin-bottom:24px; }
.tg-title { font-family:'Share Tech Mono',monospace; font-size:.62rem; letter-spacing:3px; color:var(--dim); margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid var(--border); }
.tg-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.tg-field { display:flex; flex-direction:column; gap:4px; }
.tg-label { font-size:.78rem; color:var(--text); }
.tg-input { background:var(--bg3); border:1px solid var(--border); color:var(--white); font-family:'Share Tech Mono',monospace; font-size:.82rem; padding:6px 10px; border-radius:2px; outline:none; transition:border-color .2s; }
.tg-input:focus { border-color:var(--cyan); }
.modal-actions { display:flex; gap:10px; margin-top:24px; justify-content:flex-end; }
.btn { font-family:'Share Tech Mono',monospace; font-size:.65rem; letter-spacing:2px; padding:8px 18px; border-radius:2px; cursor:pointer; transition:all .2s; border:none; }
.btn-primary { background:var(--cyan); color:var(--bg); font-weight:700; }
.btn-primary:hover { box-shadow:0 0 16px rgba(0,212,255,.4); }
.btn-secondary { background:none; border:1px solid var(--dim); color:var(--dim); }
.btn-secondary:hover { border-color:var(--white); color:var(--white); }
.btn-danger { background:none; border:1px solid rgba(255,61,61,.4); color:var(--red); }
.btn-danger:hover { background:rgba(255,61,61,.1); }
.save-status { font-family:'Share Tech Mono',monospace; font-size:.65rem; color:var(--green); opacity:0; transition:opacity .3s; align-self:center; }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width:1100px) {
  .stat-cards { grid-template-columns:repeat(2,1fr); }
  .sysinfo-grid { grid-template-columns:repeat(2,1fr); }
}
@media (max-width:700px) {
  .stat-cards { grid-template-columns:1fr; }
  .sysinfo-grid { grid-template-columns:1fr; }
  .charts-row { grid-template-columns:1fr; }
}
/* â”€â”€ WHAT'S NEW WALKTHROUGH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#wn-overlay { display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,.82); backdrop-filter:blur(6px); align-items:center; justify-content:center; }
#wn-overlay.open { display:flex; }
#wn-box { background:linear-gradient(135deg,var(--bg2),var(--bg3)); border:1px solid var(--border3); border-radius:6px; width:520px; max-width:94vw; padding:32px; box-shadow:0 0 80px rgba(0,170,255,.12); position:relative; }
#wn-badge { font-family:'Share Tech Mono',monospace; font-size:.6rem; letter-spacing:4px; color:var(--cyan); margin-bottom:10px; }
#wn-title { font-family:'Rajdhani',sans-serif; font-size:1.6rem; font-weight:700; color:var(--white); margin-bottom:6px; }
#wn-sub { font-size:.78rem; color:var(--dim); margin-bottom:24px; }
#wn-steps { list-style:none; padding:0; margin:0 0 28px; }
#wn-steps li { display:none; font-size:.85rem; color:var(--text); line-height:1.7; }
#wn-steps li.active { display:block; }
#wn-steps .wn-icon { font-size:1.4rem; margin-bottom:8px; display:block; }
#wn-steps .wn-step-title { font-weight:600; color:var(--white); font-size:.95rem; }
#wn-dots { display:flex; gap:7px; margin-bottom:24px; }
.wn-dot { width:8px; height:8px; border-radius:50%; background:var(--border3); transition:background .2s; cursor:pointer; }
.wn-dot.active { background:var(--cyan); }
#wn-actions { display:flex; gap:10px; align-items:center; }
#wn-next { background:var(--cyan); border:none; color:var(--bg); font-family:'Share Tech Mono',monospace; font-size:.72rem; letter-spacing:2px; padding:9px 20px; border-radius:3px; cursor:pointer; }
#wn-next:hover { filter:brightness(1.15); }
#wn-skip { background:none; border:none; color:var(--dim); font-size:.75rem; cursor:pointer; }
#wn-skip:hover { color:var(--white); }
#wn-progress { font-family:'Share Tech Mono',monospace; font-size:.65rem; color:var(--dim); margin-left:auto; }
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading">
  <div class="loading-logo">KAM SENTINEL</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
  <div class="loading-msg" id="loading-msg">INITIALIZING SYSTEM SCAN...</div>
</div>

<!-- HEADER -->
<header>
  <div class="logo" style="display:flex;align-items:center;gap:4px;">
    <svg width="32" height="32" viewBox="0 0 160 160" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <clipPath id="shield-clip">
          <path d="M80 12 L138 36 L138 90 Q138 130 80 150 Q22 130 22 90 L22 36 Z"/>
        </clipPath>
        <radialGradient id="sg" cx="50%" cy="45%" r="55%">
          <stop offset="0%" stop-color="#00e5ff" stop-opacity="0.12"/>
          <stop offset="100%" stop-color="#00ff88" stop-opacity="0"/>
        </radialGradient>
        <filter id="glow">
          <feGaussianBlur stdDeviation="2" result="blur"/>
          <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <!-- Shield body -->
      <path d="M80 12 L138 36 L138 90 Q138 130 80 150 Q22 130 22 90 L22 36 Z" fill="url(#sg)"/>
      <!-- Radar rings -->
      <g clip-path="url(#shield-clip)" opacity="0.2">
        <circle cx="80" cy="76" r="22" fill="none" stroke="#00e5ff" stroke-width="1"/>
        <circle cx="80" cy="76" r="40" fill="none" stroke="#00e5ff" stroke-width="1"/>
        <circle cx="80" cy="76" r="58" fill="none" stroke="#00e5ff" stroke-width="1"/>
        <path d="M80 76 L80 16 A64 64 0 0 1 135 100 Z" fill="#00ff88" opacity="0.1"/>
      </g>
      <!-- Shield outline with glow -->
      <path d="M80 12 L138 36 L138 90 Q138 130 80 150 Q22 130 22 90 L22 36 Z" 
            fill="none" stroke="#00ff88" stroke-width="2.5" stroke-linejoin="round" filter="url(#glow)"/>
      <!-- K letterform -->
      <line x1="66" y1="44" x2="66" y2="108" stroke="#00ff88" stroke-width="5.5" stroke-linecap="round"/>
      <line x1="66" y1="76" x2="102" y2="44" stroke="#00ff88" stroke-width="5.5" stroke-linecap="round"/>
      <line x1="66" y1="76" x2="102" y2="108" stroke="#00ff88" stroke-width="5.5" stroke-linecap="round"/>
      <!-- Center eye -->
      <circle cx="80" cy="76" r="5" fill="#00ff88" opacity="0.9"/>
      <circle cx="82" cy="74" r="2" fill="#00e5ff" opacity="0.8"/>
    </svg><span style="color:var(--green);text-shadow:0 0 20px rgba(0,255,136,.4);">AM</span>&nbsp;<em style="font-size:.7rem;letter-spacing:2px;color:var(--dim2);">SENTINEL</em>
  </div>
  <div class="hdr-meta">
    <div class="live-dot"></div>
    <span class="mono" id="last-update">--:--:--</span>
    <div class="refresh-control">
      <span class="mono" style="font-size:.65rem;">REFRESH</span>
      <select id="refresh-select" class="refresh-select" onchange="updateRefreshRate(this.value)">
        <option value="2000">2s</option>
        <option value="5000" selected>5s</option>
        <option value="10000">10s</option>
        <option value="30000">30s</option>
        <option value="60000">60s</option>
      </select>
    </div>
    <button class="settings-btn" id="overlay-btn" onclick="toggleOverlay()">âŠ OVERLAY</button>
    <button class="settings-btn" id="diag-test-btn" onclick="toggleDiagTestMode()" title="Simulate N/A states for testing">ğŸ§ª TEST MODE</button>
    <button class="settings-btn" onclick="openFeedback()">ğŸ’¬ FEEDBACK</button>
    <button class="settings-btn" onclick="openSettings()">âš™ THRESHOLDS</button>
  </div>
</header>

<main>

  <!-- WARNINGS PANEL -->
  <div id="warnings-panel" class="warnings-panel"></div>

  <!-- SYSTEM INFO -->
  <div class="section-label">SYSTEM INFORMATION</div>
  <div class="sysinfo-grid">

    <div class="sysinfo-card">
      <div class="si-title">HARDWARE</div>
      <div class="si-row"><span class="si-key">Manufacturer</span><span class="si-val" id="si-mfr">â€”</span></div>
      <div class="si-row"><span class="si-key">Model</span><span class="si-val" id="si-model">â€”</span></div>
      <div class="si-row"><span class="si-key">Motherboard</span><span class="si-val" id="si-mobo">â€”</span></div>
      <div class="si-row"><span class="si-key">BIOS</span><span class="si-val accent-cyan" id="si-bios">â€”</span></div>
    </div>

    <div class="sysinfo-card">
      <div class="si-title">PROCESSOR & MEMORY</div>
      <div class="si-row"><span class="si-key">CPU</span><span class="si-val accent-cyan" id="si-cpu">â€”</span></div>
      <div class="si-row"><span class="si-key">Cores / Threads</span><span class="si-val" id="si-cores">â€”</span></div>
      <div class="si-row"><span class="si-key">Max Clock</span><span class="si-val" id="si-maxghz">â€”</span></div>
      <div class="si-row"><span class="si-key">RAM</span><span class="si-val accent-purple" id="si-ram">â€”</span></div>
      <div class="si-row"><span class="si-key">Page File</span><span class="si-val" id="si-page">â€”</span></div>
    </div>

    <div class="sysinfo-card">
      <div class="si-title">SYSTEM & DISPLAY</div>
      <div class="si-row"><span class="si-key">OS</span><span class="si-val" id="si-os">â€”</span></div>
      <div class="si-row"><span class="si-key">Windows Dir</span><span class="si-val" id="si-windir">â€”</span></div>
      <div class="si-row"><span class="si-key">DirectX</span><span class="si-val accent-green" id="si-dx">â€”</span></div>
      <div class="si-row"><span class="si-key">GPU</span><span class="si-val accent-green" id="si-gpu">â€”</span></div>
      <div class="si-row"><span class="si-key">VRAM</span><span class="si-val" id="si-vram">â€”</span></div>
    </div>

  </div>

  <!-- LIVE METRICS -->
  <div class="section-label">LIVE PERFORMANCE</div>
  <div class="stat-cards">

    <!-- CPU -->
    <div class="stat-card card-cpu">
      <div class="card-tag">CPU</div>
      <div class="card-big"><span id="cpu-usage">--</span><span class="card-unit">%</span></div>
      <div class="card-details">
        <div class="card-detail-row"><span class="cd-k">Temp</span><span class="cd-v" id="cpu-temp">-- Â°C</span><button class="diag-btn" id="diag-cpu-temp" onclick="showDiag('cpu_temp')" title="Diagnostic info" style="display:none">âš </button></div>
        <div class="card-detail-row"><span class="cd-k">Voltage</span><span class="cd-v" id="cpu-volt">-- V</span><button class="diag-btn" id="diag-cpu-volt" onclick="showDiag('wmi')" title="Diagnostic info" style="display:none">âš </button></div>
        <div class="card-detail-row"><span class="cd-k">Clock</span><span class="cd-v" id="cpu-freq">-- GHz</span></div>
        <div class="card-detail-row"><span class="cd-k">Cores / Threads</span><span class="cd-v" id="cpu-cores">--</span></div>
      </div>
      <div class="bar"><div class="bar-fill" id="cpu-bar" style="width:0%"></div></div>
    </div>

    <!-- GPU -->
    <div class="stat-card card-gpu">
      <div class="card-tag">GPU</div>
      <div class="card-big"><span id="gpu-usage">--</span><span class="card-unit">%</span></div>
      <div class="card-details">
        <div class="card-detail-row"><span class="cd-k">Temp</span><span class="cd-v" id="gpu-temp">-- Â°C</span><button class="diag-btn" id="diag-gpu-temp" onclick="showDiag('gpu')" title="Diagnostic info" style="display:none">âš </button></div>
        <div class="card-detail-row"><span class="cd-k">VRAM Used</span><span class="cd-v" id="gpu-vram">-- MB</span></div>
        <div class="card-detail-row"><span class="cd-k">Name</span><span class="cd-v" id="gpu-name" style="font-size:.75rem">--</span></div>
      </div>
      <div class="bar"><div class="bar-fill" id="gpu-bar" style="width:0%"></div></div>
    </div>

    <!-- RAM -->
    <div class="stat-card card-ram">
      <div class="card-tag">RAM</div>
      <div class="card-big"><span id="ram-usage">--</span><span class="card-unit">%</span></div>
      <div class="card-details">
        <div class="card-detail-row"><span class="cd-k">Used</span><span class="cd-v" id="ram-used">-- GB</span></div>
        <div class="card-detail-row"><span class="cd-k">Available</span><span class="cd-v" id="ram-avail">-- GB</span></div>
        <div class="card-detail-row"><span class="cd-k">Total</span><span class="cd-v" id="ram-total">-- GB</span></div>
      </div>
      <div class="bar"><div class="bar-fill" id="ram-bar" style="width:0%"></div></div>
    </div>

    <!-- NETWORK -->
    <div class="stat-card card-net">
      <div class="card-tag">NETWORK</div>
      <div class="net-split">
        <div class="net-half">
          <div class="net-label">â–² UPLOAD</div>
          <div class="net-val" id="net-up">-- KB/s</div>
        </div>
        <div class="net-half">
          <div class="net-label">â–¼ DOWNLOAD</div>
          <div class="net-val" id="net-down">-- KB/s</div>
        </div>
      </div>
      <div class="card-details" style="margin-top:10px">
        <div class="card-detail-row"><span class="cd-k">Upload kbps</span><span class="cd-v" id="net-up-raw">--</span></div>
        <div class="card-detail-row"><span class="cd-k">Download kbps</span><span class="cd-v" id="net-down-raw">--</span></div>
      </div>
      <div class="bar"><div class="bar-fill" id="net-bar" style="width:0%"></div></div>
    </div>

  </div>

  <!-- CHARTS -->
  <div class="section-label">PERFORMANCE HISTORY</div>
  <div class="charts-row">

    <div class="chart-card">
      <div class="chart-hdr">
        <span class="chart-title">CPU & GPU USAGE (%)</span>
        <div class="chart-legend">
          <div class="leg-item"><div class="leg-dot" style="background:var(--cyan)"></div>CPU</div>
          <div class="leg-item"><div class="leg-dot" style="background:var(--green)"></div>GPU</div>
        </div>
      </div>
      <canvas id="chart-usage"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-hdr">
        <span class="chart-title">TEMPERATURE (Â°C)</span>
        <div class="chart-legend">
          <div class="leg-item"><div class="leg-dot" style="background:var(--cyan)"></div>CPU</div>
          <div class="leg-item"><div class="leg-dot" style="background:var(--orange)"></div>GPU</div>
        </div>
      </div>
      <canvas id="chart-temp"></canvas>
    </div>

  </div>

</main>

<footer>KAM Sentinel v1.0 â€” Phase 1 &nbsp;|&nbsp; Running locally on port 5000 &nbsp;|&nbsp; Original profile backed up on first launch</footer>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <div class="modal-hdr">
      <span class="modal-title">WARNING THRESHOLDS</span>
      <button class="modal-close" onclick="closeSettings()">âœ•</button>
    </div>
    <div class="modal-detected" id="modal-detected">Detected hardware: loading...</div>

    <div class="threshold-group">
      <div class="tg-title">CPU TEMPERATURE (Â°C)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">âš¡ Warning at</label><input class="tg-input" id="t-cpu-temp-warn" type="number" step="1"></div>
        <div class="tg-field"><label class="tg-label">ğŸ”´ Critical at</label><input class="tg-input" id="t-cpu-temp-crit" type="number" step="1"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">GPU TEMPERATURE (Â°C)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">âš¡ Warning at</label><input class="tg-input" id="t-gpu-temp-warn" type="number" step="1"></div>
        <div class="tg-field"><label class="tg-label">ğŸ”´ Critical at</label><input class="tg-input" id="t-gpu-temp-crit" type="number" step="1"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">CPU VOLTAGE (V)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">Min safe voltage</label><input class="tg-input" id="t-volt-min" type="number" step="0.01"></div>
        <div class="tg-field"><label class="tg-label">Max safe voltage</label><input class="tg-input" id="t-volt-max" type="number" step="0.01"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">CPU USAGE (%)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">âš¡ Warning at</label><input class="tg-input" id="t-cpu-use-warn" type="number" step="1" min="1" max="100"></div>
        <div class="tg-field"><label class="tg-label">ğŸ”´ Critical at</label><input class="tg-input" id="t-cpu-use-crit" type="number" step="1" min="1" max="100"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">GPU USAGE (%)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">âš¡ Warning at</label><input class="tg-input" id="t-gpu-use-warn" type="number" step="1" min="1" max="100"></div>
        <div class="tg-field"><label class="tg-label">ğŸ”´ Critical at</label><input class="tg-input" id="t-gpu-use-crit" type="number" step="1" min="1" max="100"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">RAM USAGE (%)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">âš¡ Warning at</label><input class="tg-input" id="t-ram-warn" type="number" step="1" min="1" max="100"></div>
        <div class="tg-field"><label class="tg-label">ğŸ”´ Critical at</label><input class="tg-input" id="t-ram-crit" type="number" step="1" min="1" max="100"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">SUSTAINED USAGE ALERT (seconds of high usage before warning)</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">CPU sustain window (sec)</label><input class="tg-input" id="t-cpu-sustain" type="number" step="5" min="5"></div>
        <div class="tg-field"><label class="tg-label">GPU sustain window (sec)</label><input class="tg-input" id="t-gpu-sustain" type="number" step="5" min="5"></div>
      </div>
    </div>

    <div class="threshold-group">
      <div class="tg-title">NETWORK ANOMALY</div>
      <div class="tg-grid">
        <div class="tg-field"><label class="tg-label">Spike multiplier (x baseline)</label><input class="tg-input" id="t-net-mult" type="number" step="0.5" min="1.5"></div>
        <div class="tg-field"><label class="tg-label">Baseline sample count</label><input class="tg-input" id="t-net-samples" type="number" step="1" min="5"></div>
      </div>
    </div>

    <div class="modal-actions">
      <span class="save-status" id="save-status">âœ“ SAVED</span>
      <button class="btn btn-danger" onclick="resetThresholds()">RESET TO DEFAULTS</button>
      <button class="btn btn-secondary" onclick="closeSettings()">CANCEL</button>
      <button class="btn btn-primary" onclick="saveThresholds()">SAVE THRESHOLDS</button>
    </div>
  </div>
</div>

<!-- FEEDBACK MODAL -->
<div class="feedback-modal" id="feedback-modal">
  <div class="feedback-box">
    <div class="feedback-title">ğŸ’¬ SEND FEEDBACK</div>
    <div class="feedback-cats">
      <button class="fb-cat active" data-cat="bug" onclick="selectCat(this)">ğŸ› BUG</button>
      <button class="fb-cat" data-cat="performance" onclick="selectCat(this)">âš¡ PERFORMANCE</button>
      <button class="fb-cat" data-cat="feature" onclick="selectCat(this)">âœ¨ FEATURE REQUEST</button>
      <button class="fb-cat" data-cat="general" onclick="selectCat(this)">ğŸ’¡ GENERAL</button>
    </div>
    <textarea class="fb-textarea" id="fb-message" placeholder="Describe the issue or idea... The more detail the better!"></textarea>
    <div class="fb-footer">
      <span class="fb-note">ğŸ”’ No personal data collected</span>
      <div class="fb-actions">
        <button class="fb-cancel" onclick="closeFeedback()">CANCEL</button>
        <button class="fb-submit" id="fb-submit-btn" onclick="submitFeedback()">SEND â†’</button>
      </div>
    </div>
    <div id="fb-result" style="margin-top:12px; font-size:.75rem; display:none; text-align:center;"></div>
  </div>
</div>

<!-- DIAGNOSTIC MODAL -->
<div class="diag-modal" id="diag-modal">
  <div class="diag-box">
    <div class="diag-title">âš  DIAGNOSTIC â€” <span id="diag-modal-key"></span></div>
    <div class="diag-status" id="diag-modal-msg"></div>
    <div class="diag-fix" id="diag-modal-fix" style="display:none"></div>
    <div id="diag-modal-download" style="display:none; margin-bottom:12px; font-size:.75rem;">
      <a id="diag-download-link" href="#" target="_blank" style="color:var(--cyan)">ğŸ“¥ Download required software</a>
    </div>
    <div class="diag-actions">
      <button class="diag-close" onclick="closeDiag()">CLOSE</button>
      <button class="diag-autofix" id="diag-autofix-btn" style="display:none" onclick="runAutofix()">âš¡ AUTO-FIX</button>
    </div>
    <div id="diag-result" style="margin-top:12px; font-size:.75rem; color:var(--green); display:none;"></div>
  </div>
</div>

<!-- UPDATE NOTIFICATION -->
<div id="update-toast" style="display:none; position:fixed; bottom:24px; right:24px; z-index:9998;
  background:var(--bg2); border:1px solid var(--green); border-radius:8px; padding:16px 20px;
  max-width:360px; box-shadow:0 0 30px rgba(0,255,136,.15);">
  <div style="color:var(--green); font-size:.75rem; letter-spacing:2px; margin-bottom:8px;">â¬¡ UPDATE AVAILABLE</div>
  <div id="update-version" style="font-size:.85rem; color:var(--white); margin-bottom:6px;"></div>
  <div id="update-changes" style="font-size:.72rem; color:var(--dim); margin-bottom:12px; line-height:1.6;"></div>
  <div style="display:flex; gap:8px;">
    <button onclick="document.getElementById('update-toast').style.display='none'"
      style="background:none; border:1px solid var(--border2); color:var(--dim); padding:5px 12px;
      border-radius:3px; cursor:pointer; font-family:'Share Tech Mono',monospace; font-size:.65rem;">
      IGNORE
    </button>
    <a id="update-link" href="https://github.com/kypin00-web/KAM-Sentinel/releases" target="_blank"
      style="background:var(--green); color:var(--bg); padding:5px 12px; border-radius:3px;
      text-decoration:none; font-family:'Share Tech Mono',monospace; font-size:.65rem; font-weight:bold;">
      VIEW UPDATE
    </a>
  </div>
</div>

<!-- KAM OVERLAY â€” draggable floating window -->
<div id="kam-overlay">
  <div class="overlay-header">
    <span class="overlay-title">â¬¡ KAM</span>
    <button class="overlay-close" onclick="toggleOverlay()">âœ•</button>
  </div>
  <div class="overlay-row" id="ov-cpu-row">
    <span class="overlay-label">CPU</span>
    <span class="overlay-val" id="ov-cpu">--%</span>
  </div>
  <div class="overlay-row" id="ov-cpu-temp-row">
    <span class="overlay-label">CPU TEMP</span>
    <span class="overlay-val" id="ov-cpu-temp">--Â°C</span>
  </div>
  <hr class="overlay-divider">
  <div class="overlay-row" id="ov-gpu-row">
    <span class="overlay-label">GPU</span>
    <span class="overlay-val" id="ov-gpu">--%</span>
  </div>
  <div class="overlay-row" id="ov-gpu-temp-row">
    <span class="overlay-label">GPU TEMP</span>
    <span class="overlay-val" id="ov-gpu-temp">--Â°C</span>
  </div>
  <hr class="overlay-divider">
  <div class="overlay-row" id="ov-ram-row">
    <span class="overlay-label">RAM</span>
    <span class="overlay-val" id="ov-ram">--%</span>
  </div>
  <div class="overlay-settings-row">
    <button class="overlay-toggle active" id="ov-tog-cpu" onclick="overlayToggle('cpu')">CPU</button>
    <button class="overlay-toggle active" id="ov-tog-gpu" onclick="overlayToggle('gpu')">GPU</button>
    <button class="overlay-toggle active" id="ov-tog-ram" onclick="overlayToggle('ram')">RAM</button>
    <button class="overlay-toggle active" id="ov-tog-temp" onclick="overlayToggle('temp')">TEMP</button>
  </div>
</div>

<script>
// â”€â”€ DOM cache â€” built once at init, never queried in hot path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DOM = {};
function cacheDom() {
  [
    'last-update','cpu-usage','cpu-bar','cpu-temp','cpu-volt','cpu-freq','cpu-cores',
    'gpu-usage','gpu-bar','gpu-temp','gpu-vram','gpu-name',
    'ram-usage','ram-bar','ram-used','ram-avail','ram-total',
    'net-up','net-down','net-up-raw','net-down-raw','net-bar',
    'warnings-panel','loading','loading-msg','settings-modal',
    'modal-detected','save-status',
    'si-mfr','si-model','si-mobo','si-bios','si-cpu','si-cores',
    'si-maxghz','si-ram','si-page','si-os','si-windir','si-dx','si-gpu','si-vram',
  ].forEach(id => DOM[id] = document.getElementById(id));
}

const CHART_OPTS = (yMax=100) => ({
  responsive:true, maintainAspectRatio:true,
  animation:{ duration:300 },
  plugins:{ legend:{ display:false }, tooltip:{ enabled:true, mode:'index', intersect:false }},
  scales:{
    x:{ display:false },
    y:{ min:0, max:yMax, grid:{ color:'rgba(255,255,255,.04)' },
        ticks:{ color:'#3d5166', font:{ size:10, family:'Share Tech Mono' }}}
  }
});

const mkChart = (id, datasets, yMax) => new Chart(document.getElementById(id), {
  type:'line', data:{ labels:[], datasets }, options: CHART_OPTS(yMax)
});

const line = (color, label) => ({
  label, data:[], borderColor:color,
  backgroundColor: color.replace(')',', 0.08)').replace('rgb','rgba'),
  borderWidth:1.5, pointRadius:0, tension:.4, fill:true, spanGaps:true
});

let chartUsage, chartTemp;

function initCharts() {
  chartUsage = mkChart('chart-usage', [
    line('rgb(0,212,255)', 'CPU %'),
    line('rgb(0,255,136)', 'GPU %'),
  ], 100);

  chartTemp = mkChart('chart-temp', [
    line('rgb(0,212,255)', 'CPU Â°C'),
    line('rgb(255,112,67)', 'GPU Â°C'),
  ], 100);
}

function pushChart(chart, label, ...vals) {
  chart.data.labels.push(label);
  vals.forEach((v,i) => chart.data.datasets[i].data.push(v ?? null));
  if(chart.data.labels.length > 60) {
    chart.data.labels.splice(0,1);
    chart.data.datasets.forEach(d => d.data.splice(0,1));
  }
  chart.update('none');
}

// â”€â”€ Temp color helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tempClass(v, warn=75, hot=90) {
  if(v===null||v===undefined) return '';
  return v>=hot?'hot':v>=warn?'warn':'ok';
}

// â”€â”€ Load system info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSystemInfo() {
  DOM['loading-msg'].textContent = 'SCANNING HARDWARE...';
  const r = await fetch('/api/system');
  const s = await r.json();
  const set = (id, val, fallback='N/A') => { if(DOM[id]) DOM[id].textContent = val || fallback; };
  set('si-mfr',    s.manufacturer);
  set('si-model',  s.model);
  set('si-mobo',   s.motherboard);
  set('si-bios',   s.bios_version);
  set('si-cpu',    s.cpu_name);
  set('si-cores',  `${s.cpu_cores} / ${s.cpu_threads}`);
  set('si-maxghz', s.cpu_max_ghz !== 'N/A' ? `${s.cpu_max_ghz} GHz` : 'N/A');
  set('si-ram',    `${s.ram_total_mb} MB  (${s.ram_total_gb} GB)`);
  set('si-page',   s.pagefile_total_mb ? `${s.pagefile_used_mb} MB used / ${s.pagefile_total_mb} MB` : 'N/A');
  set('si-os',     `Windows ${s.os_release}`);
  set('si-windir', s.windows_dir);
  set('si-dx',     s.directx);
  set('si-gpu',    s.gpu_name);
  set('si-vram',   s.gpu_vram_mb !== 'N/A' ? `${s.gpu_vram_mb} MB` : 'N/A');
}

// â”€â”€ FIX: Single fetch per cycle â€” one round trip instead of multiple â”€â”€â”€â”€â”€â”€
async function fetchStats() {
  try {
    const r = await fetch('/api/stats');
    const d = await r.json();
    const cpu = d.cpu, ram = d.ram, gpu = d.gpu, net = d.network;
    const ts  = new Date(d.timestamp * 1000).toLocaleTimeString();

    DOM['last-update'].textContent = ts;

    // CPU
    DOM['cpu-usage'].textContent   = cpu.usage ?? '--';
    DOM['cpu-bar'].style.width     = (cpu.usage||0) + '%';
    DOM['cpu-temp'].textContent    = cpu.temp !== null ? cpu.temp + ' Â°C' : 'N/A';
    DOM['cpu-temp'].className      = 'cd-v ' + tempClass(cpu.temp, 75, 90);
    DOM['cpu-volt'].textContent    = cpu.voltage !== null ? cpu.voltage + ' V' : 'N/A';
    DOM['cpu-freq'].textContent    = cpu.freq_ghz !== null ? cpu.freq_ghz + ' GHz' : 'N/A';
    DOM['cpu-cores'].textContent   = cpu.cores && cpu.threads ? `${cpu.cores} / ${cpu.threads}` : '--';

    // GPU
    DOM['gpu-usage'].textContent   = gpu.usage !== null ? gpu.usage : '--';
    DOM['gpu-bar'].style.width     = (gpu.usage||0) + '%';
    DOM['gpu-temp'].textContent    = gpu.temp !== null ? gpu.temp + ' Â°C' : 'N/A';
    DOM['gpu-temp'].className      = 'cd-v ' + tempClass(gpu.temp, 80, 95);
    DOM['gpu-vram'].textContent    = gpu.vram_used !== null ? `${gpu.vram_used} / ${gpu.vram_total} MB` : 'N/A';
    DOM['gpu-name'].textContent    = gpu.name || 'N/A';

    // RAM
    DOM['ram-usage'].textContent   = ram.usage_percent;
    DOM['ram-bar'].style.width     = ram.usage_percent + '%';
    DOM['ram-used'].textContent    = ram.used_gb + ' GB';
    DOM['ram-avail'].textContent   = ram.available_gb + ' GB';
    DOM['ram-total'].textContent   = ram.total_gb + ' GB';

    // Network
    DOM['net-up'].textContent      = net.upload_display;
    DOM['net-down'].textContent    = net.download_display;
    DOM['net-up-raw'].textContent  = net.upload_kbps + ' kbps';
    DOM['net-down-raw'].textContent= net.download_kbps + ' kbps';
    const netPct = Math.min((net.download_kbps / 12500) * 100, 100);
    DOM['net-bar'].style.width     = netPct + '%';

    // Charts â€” use history from server for accuracy
    if(d.history && d.history.timestamps.length) {
      const h = d.history;
      const labels = h.timestamps.map(t => new Date(t*1000).toLocaleTimeString());
      chartUsage.data.labels                  = labels;
      chartUsage.data.datasets[0].data        = h.cpu_usage;
      chartUsage.data.datasets[1].data        = h.gpu_usage;
      chartTemp.data.labels                   = labels;
      chartTemp.data.datasets[0].data         = h.cpu_temp;
      chartTemp.data.datasets[1].data         = h.gpu_temp;
      chartUsage.update('none');
      chartTemp.update('none');
    }

    // Warnings
    renderWarnings(d.warnings || []);
    checkNAIndicators(cpu, gpu);
    updateOverlay(cpu, gpu, ram);

  } catch(e) {
    console.warn('Stats fetch error:', e);
  }
}

// â”€â”€ Warnings panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _dismissed = new Set();

function renderWarnings(warnings) {
  const panel = DOM['warnings-panel'];
  const active = warnings.filter(w => !_dismissed.has(w.id));
  if(!active.length) { panel.innerHTML = ''; return; }
  panel.innerHTML = active.map(w => `
    <div class="warn-item ${w.level}" id="warn-${w.id}">
      <span class="warn-icon">${w.level==='critical'?'ğŸ”´':'âš¡'}</span>
      <span><span class="warn-component">[${w.component}]</span>${w.message}</span>
      <button class="warn-clear-btn" onclick="dismissWarning('${w.id}')">âœ•</button>
    </div>`).join('');
}

function dismissWarning(id) {
  _dismissed.add(id);
  const el = document.getElementById('warn-'+id);
  if(el) el.remove();
  setTimeout(() => _dismissed.delete(id), 60000);
}

// â”€â”€ Settings modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _thresholds = {};

async function loadThresholds() {
  const r = await fetch('/api/thresholds');
  _thresholds = await r.json();
  populateModal(_thresholds);
  const det = _thresholds._detected_from || {};
  DOM['modal-detected'].textContent =
    `Smart defaults detected from: ${det.cpu||'Unknown CPU'} / ${det.gpu||'Unknown GPU'}`;
}

function populateModal(t) {
  const set = (id, val) => { const el=document.getElementById(id); if(el&&val!=null) el.value=val; };
  set('t-cpu-temp-warn', t.cpu?.temp_warn);
  set('t-cpu-temp-crit', t.cpu?.temp_crit);
  set('t-gpu-temp-warn', t.gpu?.temp_warn);
  set('t-gpu-temp-crit', t.gpu?.temp_crit);
  set('t-volt-min',      t.voltage?.cpu_min);
  set('t-volt-max',      t.voltage?.cpu_max);
  set('t-cpu-use-warn',  t.cpu?.usage_warn);
  set('t-cpu-use-crit',  t.cpu?.usage_crit);
  set('t-gpu-use-warn',  t.gpu?.usage_warn);
  set('t-gpu-use-crit',  t.gpu?.usage_crit);
  set('t-ram-warn',      t.ram?.usage_warn);
  set('t-ram-crit',      t.ram?.usage_crit);
  set('t-cpu-sustain',   t.cpu?.usage_sustain_sec);
  set('t-gpu-sustain',   t.gpu?.usage_sustain_sec);
  set('t-net-mult',      t.network?.spike_multiplier);
  set('t-net-samples',   t.network?.baseline_samples);
}

function openSettings()  { DOM['settings-modal'].classList.add('open'); }
function closeSettings() { DOM['settings-modal'].classList.remove('open'); }

async function saveThresholds() {
  const get = id => parseFloat(document.getElementById(id)?.value);
  const payload = {
    cpu:     { temp_warn:get('t-cpu-temp-warn'), temp_crit:get('t-cpu-temp-crit'),
               usage_warn:get('t-cpu-use-warn'), usage_crit:get('t-cpu-use-crit'),
               usage_sustain_sec:get('t-cpu-sustain') },
    gpu:     { temp_warn:get('t-gpu-temp-warn'), temp_crit:get('t-gpu-temp-crit'),
               usage_warn:get('t-gpu-use-warn'), usage_crit:get('t-gpu-use-crit'),
               usage_sustain_sec:get('t-gpu-sustain') },
    ram:     { usage_warn:get('t-ram-warn'), usage_crit:get('t-ram-crit') },
    voltage: { cpu_min:get('t-volt-min'), cpu_max:get('t-volt-max') },
    network: { spike_multiplier:get('t-net-mult'), baseline_samples:get('t-net-samples') },
  };
  await fetch('/api/thresholds', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  DOM['save-status'].style.opacity = '1';
  setTimeout(() => DOM['save-status'].style.opacity = '0', 2000);
  _dismissed.clear();
}

async function resetThresholds() {
  if(!confirm('Reset all thresholds to smart defaults based on your hardware?')) return;
  const r = await fetch('/api/thresholds/reset', {method:'POST'});
  const data = await r.json();
  _thresholds = data.thresholds;
  populateModal(_thresholds);
  _dismissed.clear();
}

DOM['settings-modal']?.addEventListener('click', function(e) {
  if(e.target === this) closeSettings();
});

// â”€â”€ Feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _fbCat = 'bug';

function openFeedback() {
  document.getElementById('feedback-modal').classList.add('open');
  document.getElementById('fb-message').focus();
}

function closeFeedback() {
  document.getElementById('feedback-modal').classList.remove('open');
  document.getElementById('fb-message').value = '';
  document.getElementById('fb-result').style.display = 'none';
}

function selectCat(btn) {
  document.querySelectorAll('.fb-cat').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  _fbCat = btn.dataset.cat;
}

async function submitFeedback() {
  const msg = document.getElementById('fb-message').value.trim();
  const btn = document.getElementById('fb-submit-btn');
  const res = document.getElementById('fb-result');
  if(!msg) { res.textContent='Please enter a message'; res.style.color='var(--red)'; res.style.display='block'; return; }
  btn.disabled = true; btn.textContent = 'â³ SENDING...';
  try {
    const r = await fetch('/api/feedback', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ category: _fbCat, message: msg })
    });
    const data = await r.json();
    const priorityColors = {
      critical: 'var(--red)',
      high:     'var(--yellow)',
      review:   'var(--cyan)',
      normal:   'var(--green)',
      low:      'var(--green)',
    };
    res.textContent = `${data.message || 'Sent!'} (ID: ${data.id || '?'})`;
    res.style.color = priorityColors[data.priority] || 'var(--green)';
    res.style.display = 'block';
    btn.textContent = 'âœ“ SENT';
    setTimeout(closeFeedback, 2500);
  } catch(e) {
    res.textContent = 'Failed to send â€” check server is running';
    res.style.color = 'var(--red)'; res.style.display = 'block';
    btn.disabled = false; btn.textContent = 'SEND â†’';
  }
}

// â”€â”€ Diagnostics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _diagData = {};
let _diagTestMode = false;

async function loadDiagnostics() {
  try {
    const url = '/api/diagnostics' + (_diagTestMode ? '?test=1' : '');
    const r = await fetch(url);
    _diagData = await r.json();
    updateDiagIndicators();
  } catch(e) {}
}

function toggleDiagTestMode() {
  _diagTestMode = !_diagTestMode;
  const btn = document.getElementById('diag-test-btn');
  if(btn) {
    btn.textContent = _diagTestMode ? 'ğŸ§ª TEST MODE ON' : 'ğŸ§ª TEST MODE';
    btn.style.borderColor = _diagTestMode ? 'var(--yellow)' : '';
    btn.style.color = _diagTestMode ? 'var(--yellow)' : '';
  }
  loadDiagnostics();
}

function updateDiagIndicators() {
  const show = (id, cond) => { const el=document.getElementById(id); if(el) el.style.display=cond?'inline-block':'none'; };
  show('diag-cpu-temp', _diagData.cpu_temp && _diagData.cpu_temp.status !== 'ok');
  show('diag-cpu-volt', _diagData.wmi     && _diagData.wmi.status     !== 'ok');
  show('diag-gpu-temp', _diagData.gpu     && _diagData.gpu.status     !== 'ok');
}

function showDiag(key) {
  const d = _diagData[key]; if(!d) return;
  const labels = { cpu_temp:'CPU TEMP', gpu:'GPU', wmi:'WMI / VOLTAGE' };
  document.getElementById('diag-modal-key').textContent = labels[key] || key.toUpperCase();
  document.getElementById('diag-modal-msg').textContent = d.message || '';
  const fixEl = document.getElementById('diag-modal-fix');
  if(d.fix) { fixEl.textContent = d.fix; fixEl.style.display='block'; } else { fixEl.style.display='none'; }
  const dlEl = document.getElementById('diag-modal-download');
  if(d.download) { document.getElementById('diag-download-link').href=d.download; dlEl.style.display='block'; }
  else { dlEl.style.display='none'; }
  const fixBtn = document.getElementById('diag-autofix-btn');
  fixBtn.style.display = d.auto_fix ? 'inline-block' : 'none';
  fixBtn.dataset.fix = d.fix || '';
  fixBtn.textContent = 'âš¡ AUTO-FIX';
  fixBtn.disabled = false;
  document.getElementById('diag-result').style.display='none';
  document.getElementById('diag-modal').classList.add('open');
}

function closeDiag() { document.getElementById('diag-modal').classList.remove('open'); }

async function runAutofix() {
  const btn = document.getElementById('diag-autofix-btn');
  const resultEl = document.getElementById('diag-result');
  btn.disabled = true; btn.textContent = 'â³ FIXING...';
  try {
    const r = await fetch('/api/autofix', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({fix: btn.dataset.fix})
    });
    const data = await r.json();
    resultEl.textContent = data.message || 'Done!';
    resultEl.style.color = data.status==='ok' ? 'var(--green)' : 'var(--red)';
    resultEl.style.display = 'block';
    if(data.status==='ok') { btn.textContent='âœ“ DONE'; setTimeout(loadDiagnostics, 1500); }
  } catch(e) {
    resultEl.textContent = 'Fix failed â€” try manually in Command Prompt';
    resultEl.style.color = 'var(--red)'; resultEl.style.display='block';
  }
  btn.disabled = false;
}

function checkNAIndicators(cpu, gpu) {
  const show = (id, cond) => { const el=document.getElementById(id); if(el) el.style.display=cond?'inline-block':'none'; };
  show('diag-cpu-temp', cpu.temp    === null || cpu.temp    === undefined);
  show('diag-cpu-volt', cpu.voltage === null || cpu.voltage === undefined);
  show('diag-gpu-temp', gpu.usage   === null || gpu.usage   === undefined);
}

// â”€â”€ Goal 10: Update notification check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkForUpdate() {
  try {
    const r = await fetch('/api/version');
    const v = await r.json();
    if(v.update_check_url) {
      const remote = await fetch(v.update_check_url);
      const rv = await remote.json();
      if(rv.version && rv.version !== v.version) {
        showUpdateBanner(rv.version, rv.changelog || '');
      }
    }
  } catch(e) { /* No update server configured yet */ }
}

function showUpdateBanner(newVersion, changes) {
  const toast = document.getElementById('update-toast');
  const vEl   = document.getElementById('update-version');
  const cEl   = document.getElementById('update-changes');
  if(!toast) return;
  vEl.textContent = `v${newVersion} is available`;
  if(changes && changes.length) {
    cEl.innerHTML = changes.slice(0,5).map(c => `â€¢ ${c}`).join('<br>');
    cEl.style.display = 'block';
  } else {
    cEl.style.display = 'none';
  }
  toast.style.display = 'block';
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Refresh rate control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _refreshInterval = null;

function updateRefreshRate(ms) {
  ms = parseInt(ms);
  if(_refreshInterval) clearInterval(_refreshInterval);
  _refreshInterval = setInterval(fetchStats, ms);
  // Save preference
  localStorage.setItem('kam_refresh_ms', ms);
}

// â”€â”€ Overlay state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _ovState = { cpu:true, gpu:true, ram:true, temp:true };
let _overlayVisible = false;

function toggleOverlay() {
  _overlayVisible = !_overlayVisible;
  const el = document.getElementById('kam-overlay');
  const btn = document.getElementById('overlay-btn');
  el.classList.toggle('visible', _overlayVisible);
  btn.style.borderColor = _overlayVisible ? 'var(--green)' : '';
  btn.style.color       = _overlayVisible ? 'var(--green)' : '';
}

function overlayToggle(key) {
  _ovState[key] = !_ovState[key];
  document.getElementById('ov-tog-'+key).classList.toggle('active', _ovState[key]);
  // Show/hide rows
  if(key === 'cpu')  document.getElementById('ov-cpu-row').style.display = _ovState.cpu ? '' : 'none';
  if(key === 'gpu')  document.getElementById('ov-gpu-row').style.display = _ovState.gpu ? '' : 'none';
  if(key === 'ram')  document.getElementById('ov-ram-row').style.display = _ovState.ram ? '' : 'none';
  if(key === 'temp') {
    document.getElementById('ov-cpu-temp-row').style.display = _ovState.temp ? '' : 'none';
    document.getElementById('ov-gpu-temp-row').style.display = _ovState.temp ? '' : 'none';
  }
}

function updateOverlay(cpu, gpu, ram) {
  if(!_overlayVisible) return;
  const el = v => document.getElementById(v);
  if(_ovState.cpu) {
    el('ov-cpu').textContent = (cpu.usage ?? '--') + '%';
    el('ov-cpu').className = 'overlay-val ' + tempClass(cpu.usage, 80, 95);
  }
  if(_ovState.temp && cpu.temp !== null) {
    el('ov-cpu-temp').textContent = cpu.temp + 'Â°C';
    el('ov-cpu-temp').className = 'overlay-val ' + tempClass(cpu.temp, 75, 90);
  }
  if(_ovState.gpu && gpu.usage !== null) {
    el('ov-gpu').textContent = (gpu.usage ?? '--') + '%';
    el('ov-gpu').className = 'overlay-val ' + tempClass(gpu.usage, 85, 97);
  }
  if(_ovState.temp && gpu.temp !== null) {
    el('ov-gpu-temp').textContent = gpu.temp + 'Â°C';
    el('ov-gpu-temp').className = 'overlay-val ' + tempClass(gpu.temp, 80, 95);
  }
  if(_ovState.ram) {
    el('ov-ram').textContent = (ram.usage_percent ?? '--') + '%';
    el('ov-ram').className = 'overlay-val ' + tempClass(ram.usage_percent, 80, 92);
  }
}

// â”€â”€ Overlay drag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  let dragging=false, ox=0, oy=0;
  document.addEventListener('DOMContentLoaded', () => {
    const ov = document.getElementById('kam-overlay');
    ov.addEventListener('mousedown', e => {
      if(e.target.tagName === 'BUTTON') return;
      dragging = true;
      ox = e.clientX - ov.offsetLeft;
      oy = e.clientY - ov.offsetTop;
      ov.style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', e => {
      if(!dragging) return;
      const x = Math.max(0, Math.min(window.innerWidth  - ov.offsetWidth,  e.clientX - ox));
      const y = Math.max(0, Math.min(window.innerHeight - ov.offsetHeight, e.clientY - oy));
      ov.style.left = x + 'px';
      ov.style.top  = y + 'px';
      ov.style.right = 'auto';
    });
    document.addEventListener('mouseup', () => {
      dragging = false;
      document.getElementById('kam-overlay').style.cursor = 'move';
    });
  });
})();

// â”€â”€ Clean shutdown when browser tab/window closes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('beforeunload', () => {
    // Use sendBeacon for reliable delivery even during page unload
    navigator.sendBeacon('/api/shutdown');
});

async function init() {
  cacheDom();
  initCharts();
  await loadSystemInfo();
  await loadThresholds();
  DOM['loading-msg'].textContent = 'LOADING METRICS...';
  await fetchStats();
  DOM['loading'].style.opacity    = '0';
  DOM['loading'].style.transition = 'opacity .5s';
  setTimeout(() => DOM['loading'].style.display = 'none', 500);
  // Restore saved refresh rate
  const savedMs = parseInt(localStorage.getItem('kam_refresh_ms') || '5000');
  const sel = document.getElementById('refresh-select');
  if(sel) sel.value = savedMs;
  _refreshInterval = setInterval(fetchStats, savedMs);
  // Load diagnostics for N/A indicators
  await loadDiagnostics();
  // Check for updates once on load (Goal 10)
  setTimeout(checkForUpdate, 3000);
}

window.addEventListener('load', init);

// â”€â”€ What's New Walkthrough â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const WN_VER_KEY = 'kam_whats_new_seen';
  const WN_VER     = '1.4.4';
  let wnStep = 0;
  let wnSteps, wnDots, wnNext, wnProgress;

  function wnBuild() {
    wnSteps    = Array.from(document.querySelectorAll('#wn-steps li'));
    wnDots     = document.getElementById('wn-dots');
    wnNext     = document.getElementById('wn-next');
    wnProgress = document.getElementById('wn-progress');
    // Build dots
    wnSteps.forEach((_, i) => {
      const d = document.createElement('span');
      d.className = 'wn-dot' + (i === 0 ? ' active' : '');
      d.onclick = () => wnGoTo(i);
      wnDots.appendChild(d);
    });
    wnUpdate();
  }

  function wnUpdate() {
    const total = wnSteps.length;
    wnSteps.forEach((el, i) => el.classList.toggle('active', i === wnStep));
    Array.from(wnDots.children).forEach((d, i) => d.classList.toggle('active', i === wnStep));
    wnProgress.textContent = (wnStep + 1) + ' / ' + total;
    wnNext.textContent = wnStep < total - 1 ? 'NEXT' : 'GOT IT';
  }

  function wnGoTo(i) { wnStep = i; wnUpdate(); }

  window.wnNext = function() {
    if(wnStep < wnSteps.length - 1) { wnStep++; wnUpdate(); }
    else wnDismiss();
  };

  window.wnDismiss = function() {
    document.getElementById('wn-overlay').classList.remove('open');
    localStorage.setItem(WN_VER_KEY, WN_VER);
  };

  // Show if this version hasn't been seen yet
  document.addEventListener('DOMContentLoaded', () => {
    if(localStorage.getItem(WN_VER_KEY) !== WN_VER) {
      wnBuild();
      // Delay slightly so the dashboard renders first
      setTimeout(() => document.getElementById('wn-overlay').classList.add('open'), 1200);
    }
  });
})();
</script>
<!-- â”€â”€ WHAT'S NEW WALKTHROUGH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="wn-overlay" role="dialog" aria-modal="true" aria-label="What's New in KAM Sentinel">
  <div id="wn-box">
    <div id="wn-badge">WHAT'S NEW</div>
    <div id="wn-title">KAM Sentinel v1.4.4</div>
    <div id="wn-sub">Phase 1 is complete. Here's what changed.</div>
    <ul id="wn-steps">
      <li class="active">
        <span class="wn-icon">&#x1F527;</span>
        <span class="wn-step-title">404 Fixed &mdash; For Good</span><br>
        Beta users hit a blank screen on launch. A PyInstaller path bug sent the server looking for dashboard.html in a temp folder that got deleted on exit. That's fixed. The dashboard now loads from the correct bundle directory every time.
      </li>
      <li>
        <span class="wn-icon">&#x1F310;</span>
        <span class="wn-step-title">Cross-Platform: Windows, Mac, Linux</span><br>
        KAM Sentinel now runs on all three platforms. Windows uses WMI for temps and voltage. macOS reads from system_profiler and ioreg. Linux uses psutil sensors. All platforms share the same dashboard.
      </li>
      <li>
        <span class="wn-icon">&#x26A1;</span>
        <span class="wn-step-title">Leaner &mdash; Lower Overhead</span><br>
        The server was rewritten from scratch. Every hardware read now happens in a background thread. When you refresh stats, the server reads from memory &mdash; zero I/O on the Flask thread. Monitoring your machine no longer competes with it.
      </li>
      <li>
        <span class="wn-icon">&#x1F4CA;</span>
        <span class="wn-step-title">Anonymous Install Telemetry</span><br>
        We now know how many installs are active and what hardware classes are represented &mdash; without storing any personal info. No hostname, IP, or username is ever collected. Just a random UUID and a hardware bucket (e.g. "AMD Ryzen 7", "NVIDIA RTX 30xx").
      </li>
      <li>
        <span class="wn-icon">&#x1F6A8;</span>
        <span class="wn-step-title">Proactive Error Tracking</span><br>
        Errors are logged to <code>logs/errors.jsonl</code> and visible at <code>/api/errors</code>. The goal: know about issues before users hit the feedback loop, not after.
      </li>
      <li>
        <span class="wn-icon">&#x2705;</span>
        <span class="wn-step-title">All Phase 1 Bugs Resolved</span><br>
        Thread safety, rate limit memory growth, network spike on first poll, log flush on tab close, feedback message injection &mdash; all fixed. Test suite: 0 failures.
      </li>
    </ul>
    <div id="wn-dots"></div>
    <div id="wn-actions">
      <button id="wn-next" onclick="wnNext()">NEXT</button>
      <button id="wn-skip" onclick="wnDismiss()">Skip</button>
      <span id="wn-progress"></span>
    </div>
  </div>
</div>
</body>
</html>
